<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CXDIP · Drivers de Comentarios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --border: #e2e8f0;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --accent: #2563eb;
      --accent-soft: #38bdf8;
      --accent-good: #16a34a;
      --accent-bad: #ef4444;
      --radius-card: 16px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.06);
    }

    * {
      box-sizing: border-box;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text-main);
    }

    .page {
      max-width: 1320px;
      margin: 0 auto;
      padding: 24px 18px 40px;
    }

    header {
      margin-bottom: 20px;
    }

    .title-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .title-main {
      font-size: 1.9rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .title-main span {
      color: var(--accent);
    }

    .title-sub {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .badge-secondary {
      padding: 6px 10px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-top: 18px;
    }

    .summary-card {
      background: var(--card);
      border-radius: var(--radius-card);
      padding: 14px 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
    }

    .summary-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 1.35rem;
      font-weight: 600;
    }

    .summary-foot {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-card);
      padding: 16px 18px 18px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      margin-top: 18px;
    }

    .card h2 {
      margin: 0 0 8px;
      font-size: 1.05rem;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    /* Fila filtro año */
    .filter-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin: 6px 0 10px;
    }

    .filter-label {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .year-select {
      padding: 4px 16px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: var(--accent);
      font-size: 0.8rem;
      color: #ffffff;
      font-weight: 600;
      outline: none;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    .year-select:hover {
      background: #1d4ed8;
      border-color: #1d4ed8;
    }

    .filter-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .table-wrapper table {
      min-width: 720px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.84rem;
    }

    thead tr {
      background: #f9fafb;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eef0f4;
    }

    th {
      text-align: left;
      color: var(--text-muted);
      font-weight: 500;
      font-size: 0.78rem;
    }

    .tbl-name {
      font-weight: 500;
    }

    .tbl-num {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr:hover {
      background: #f4f5fb;
    }

    .row-total td {
      font-weight: 600;
      background: #eef2ff;
    }

    .row-prom td {
      font-weight: 600;
      background: #e0f2fe;
    }

    .val-csat.pos, .val-uplift.pos {
      color: var(--accent-good);
    }

    .val-csat.neg, .val-uplift.neg {
      color: var(--accent-bad);
    }

    .val-csat.neutral, .val-uplift.neutral {
      color: var(--accent);
    }

    .ranking-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(0, 1fr));
      gap: 16px;
      margin-top: 18px;
    }

    .ranking-card {
      background: #f9fafb;
      border-radius: 14px;
      padding: 12px 14px 14px;
      border: 1px solid #e5e7eb;
    }

    .ranking-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .ranking-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .section-title {
      margin-top: 24px;
      margin-bottom: 4px;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .level-tag {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .plus-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 4px;
      background: #e5f0ff;
      color: var(--accent);
      font-size: 0.75rem;
      font-weight: 700;
      border: 1px solid #bfdbfe;
      margin-left: 6px;
      cursor: pointer;
    }

    .center-cell {
      padding-left: 24px;
    }

    .center-cell-empty {
      padding-left: 24px;
    }

    .note-inline {
      margin-top: 6px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    th.sortable-col {
      cursor: pointer;
      user-select: none;
    }

    .sort-label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      justify-content: flex-end;
      width: 100%;
    }

    .sort-indicator {
      font-size: 0.65rem;
      opacity: 0.5;
    }

    /* Scroll interno evoluciones */
    .table-wrapper-ranking {
      max-height: 190px;
      overflow-y: auto;
      overflow-x: auto;
      position: relative;
    }

    .table-wrapper-ranking table {
      min-width: 520px;
    }

    .table-wrapper-ranking thead th {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
    }

    /* Primera columna fija (Driver) */
    .ranking-table th:first-child,
    .ranking-table td:first-child {
      position: sticky;
      left: 0;
      z-index: 2;
      background: #f9fafb;
    }

    .ranking-table tbody td:first-child {
      background: #ffffff;
    }

    .ranking-table thead th:first-child {
      z-index: 3;
    }

    .ranking-table th:nth-child(n+2),
    .ranking-table td:nth-child(n+2) {
      width: 70px;
      white-space: nowrap;
    }

    /* Drivers en Servicios agregados */
    .drivers-cell {
      font-size: 0.78rem;
      color: var(--text-muted);
      white-space: normal;
    }

    .driver-row .drivers-cell {
      font-style: italic;
    }

    @media (max-width: 768px) {
      .page {
        padding: 16px 10px 28px;
      }

      .title-main {
        font-size: 1.5rem;
      }

      .summary-card {
        padding: 10px 12px;
      }

      .card {
        padding: 12px 12px 14px;
      }

      .table-wrapper table {
        min-width: 600px;
      }

      table {
        font-size: 0.8rem;
      }

      th, td {
        padding: 5px 6px;
      }

      .ranking-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <!-- ENCABEZADO -->
    <header>
      <div class="title-row">
        <div>
          <div class="title-main"><span>CXDIP</span> Drivers de Comentarios</div>
          <div class="title-sub">
            Panel de lectura de texto abierto. Drivers macro, servicios y centros (maqueta UI).
          </div>
        </div>
        <div class="badge-secondary">
          Demo · Valores de ejemplo (reemplazar con ETL)
        </div>
      </div>

      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">Total de respuestas</div>
          <div class="summary-value">12.540</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Respuestas con comentario</div>
          <div class="summary-value">4.320</div>
          <div class="summary-foot">34,4% aportan texto</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">CSAT global (texto)</div>
          <div class="summary-value">4,10</div>
          <div class="summary-foot">Escala 1–5 · sólo casos con comentario</div>
        </div>
      </div>
    </header>

    <!-- DRIVERS MACRO -->
    <section class="card">
      <h2>Drivers Macro</h2>
      <div class="card-subtitle">
        Tabla consolidada por driver: volumen, participación y calidad (CSAT y Uplift).
      </div>

      <!-- Selector de año -->
      <div class="filter-row">
        <span class="filter-label">Año de análisis (evolución trimestral):</span>
        <select id="year-select" class="year-select">
          <option value="2023">2023</option>
          <option value="2024" selected>2024</option>
          <option value="2025">2025</option>
        </select>
        <span class="filter-hint">Drivers Macro + Evolución CSAT / Uplift responden a este filtro.</span>
      </div>

      <div class="table-wrapper">
        <table id="drivers-table">
          <thead>
            <tr>
              <th>Driver macro</th>
              <th class="sortable-col" data-sort-type="int" style="text-align:right;">
                <span class="sort-label">
                  N° comentarios
                  <span class="sort-indicator">↕</span>
                </span>
              </th>
              <th class="sortable-col" data-sort-type="percent" style="text-align:right;">
                <span class="sort-label">
                  % sobre texto
                  <span class="sort-indicator">↕</span>
                </span>
              </th>
              <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                <span class="sort-label">
                  CSAT atributo
                  <span class="sort-indicator">↕</span>
                </span>
              </th>
              <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                <span class="sort-label">
                  Uplift atributo
                  <span class="sort-indicator">↕</span>
                </span>
              </th>
            </tr>
          </thead>
          <tbody>
            <!-- Se rellena por JS según año -->
          </tbody>
        </table>
      </div>

      <!-- EVOLUCIÓN CSAT / UPLIFT -->
      <div class="ranking-row">
        <!-- Evolución CSAT -->
        <div class="ranking-card">
          <div class="ranking-title">Evolución CSAT atributo</div>
          <div class="ranking-sub">
            Evolución del CSAT por driver entre trimestres (T1–T4) y total anual.
          </div>

          <div class="table-wrapper table-wrapper-ranking">
            <table class="ranking-table ranking-csat">
              <thead>
                <tr>
                  <th>Driver</th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">
                      T1
                      <span class="sort-indicator">↕</span>
                    </span>
                  </th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">
                      T2
                      <span class="sort-indicator">↕</span>
                    </span>
                  </th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">
                      T3
                      <span class="sort-indicator">↕</span>
                    </span>
                  </th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">
                      T4
                      <span class="sort-indicator">↕</span>
                    </span>
                  </th>
                  <th style="text-align:right;">Total anual</th>
                </tr>
              </thead>
              <tbody>
                <!-- JS -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Evolución Uplift -->
        <div class="ranking-card">
          <div class="ranking-title">Evolución Uplift atributo</div>
          <div class="ranking-sub">
            Uplift del atributo vs CSAT global (4,10) por trimestre y total anual.
          </div>

          <div class="table-wrapper table-wrapper-ranking">
            <table class="ranking-table ranking-uplift">
              <thead>
                <tr>
                  <th>Driver</th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">
                      T1
                      <span class="sort-indicator">↕</span>
                    </span>
                  </th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">
                      T2
                      <span class="sort-indicator">↕</span>
                    </span>
                  </th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">
                      T3
                      <span class="sort-indicator">↕</span>
                    </span>
                  </th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">
                      T4
                      <span class="sort-indicator">↕</span>
                    </span>
                  </th>
                  <th style="text-align:right;">Total anual</th>
                </tr>
              </thead>
              <tbody>
                <!-- JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- SERVICIOS AGREGADOS -->
    <div class="section-title">Servicios agregados</div>

    <section class="card">
      <div class="level-tag">Vista por servicio_agrupado y centro (apertura con “+”)</div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Servicio / Centro</th>
              <th>Drivers mencionados</th>
              <th style="text-align:right;">N° comentarios</th>
              <th style="text-align:right;">% sobre texto</th>
              <th style="text-align:right;">NPS</th>
              <th style="text-align:right;">CSAT atributo</th>
              <th style="text-align:right;">Uplift atributo</th>
            </tr>
          </thead>
          <tbody>
            <!-- SERVICIO 1 -->
            <tr>
              <td class="tbl-name">
                Servicio 1
                <button class="plus-btn service-toggle" data-service="serv1" data-expanded="false">+</button>
              </td>
              <td class="drivers-cell">–</td>
              <td class="tbl-num">620</td>
              <td class="tbl-num">14,4%</td>
              <td class="tbl-num">60,0</td>
              <td class="tbl-num val-csat pos">4,30</td>
              <td class="tbl-num val-uplift pos">+0,20</td>
            </tr>
            <!-- Centro 1 -->
            <tr class="center-row" data-parent="serv1" style="display:none;">
              <td class="tbl-name center-cell">↳ Centro 1</td>
              <td class="drivers-cell">Tiempos de espera</td>
              <td class="tbl-num">140</td>
              <td class="tbl-num">3,2%</td>
              <td class="tbl-num">65,0</td>
              <td class="tbl-num val-csat pos">4,60</td>
              <td class="tbl-num val-uplift pos">+0,50</td>
            </tr>
            <tr class="center-row driver-row" data-parent="serv1" style="display:none;">
              <td class="tbl-name center-cell-empty"></td>
              <td class="drivers-cell">Atención vendedor</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
            </tr>
            <!-- Centro 2 -->
            <tr class="center-row" data-parent="serv1" style="display:none;">
              <td class="tbl-name center-cell">↳ Centro 2</td>
              <td class="drivers-cell">Productos</td>
              <td class="tbl-num">120</td>
              <td class="tbl-num">2,8%</td>
              <td class="tbl-num">62,0</td>
              <td class="tbl-num val-csat pos">4,40</td>
              <td class="tbl-num val-uplift pos">+0,30</td>
            </tr>
            <tr class="center-row driver-row" data-parent="serv1" style="display:none;">
              <td class="tbl-name center-cell-empty"></td>
              <td class="drivers-cell">Logística / entrega</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
            </tr>
            <!-- Centro 3 -->
            <tr class="center-row" data-parent="serv1" style="display:none;">
              <td class="tbl-name center-cell">↳ Centro 3</td>
              <td class="drivers-cell">Atención repartidor</td>
              <td class="tbl-num">95</td>
              <td class="tbl-num">2,2%</td>
              <td class="tbl-num">58,0</td>
              <td class="tbl-num val-csat neutral">4,10</td>
              <td class="tbl-num val-uplift neutral">0,00</td>
            </tr>
            <tr class="center-row driver-row" data-parent="serv1" style="display:none;">
              <td class="tbl-name center-cell-empty"></td>
              <td class="drivers-cell">Otros</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
            </tr>

            <!-- SERVICIO 2 -->
            <tr>
              <td class="tbl-name">
                Servicio 2
                <button class="plus-btn service-toggle" data-service="serv2" data-expanded="false">+</button>
              </td>
              <td class="drivers-cell">–</td>
              <td class="tbl-num">540</td>
              <td class="tbl-num">12,5%</td>
              <td class="tbl-num">55,0</td>
              <td class="tbl-num val-csat neutral">4,10</td>
              <td class="tbl-num val-uplift neutral">0,00</td>
            </tr>
            <!-- Centro 1 -->
            <tr class="center-row" data-parent="serv2" style="display:none;">
              <td class="tbl-name center-cell">↳ Centro 1</td>
              <td class="drivers-cell">Productos</td>
              <td class="tbl-num">90</td>
              <td class="tbl-num">2,1%</td>
              <td class="tbl-num">57,0</td>
              <td class="tbl-num val-csat pos">4,20</td>
              <td class="tbl-num val-uplift pos">+0,10</td>
            </tr>
            <tr class="center-row driver-row" data-parent="serv2" style="display:none;">
              <td class="tbl-name center-cell-empty"></td>
              <td class="drivers-cell">Atención vendedor</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
            </tr>
            <!-- Centro 3 -->
            <tr class="center-row" data-parent="serv2" style="display:none;">
              <td class="tbl-name center-cell">↳ Centro 3</td>
              <td class="drivers-cell">Tiempos de espera</td>
              <td class="tbl-num">70</td>
              <td class="tbl-num">1,6%</td>
              <td class="tbl-num">50,0</td>
              <td class="tbl-num val-csat neg">3,80</td>
              <td class="tbl-num val-uplift neg">-0,30</td>
            </tr>
            <tr class="center-row driver-row" data-parent="serv2" style="display:none;">
              <td class="tbl-name center-cell-empty"></td>
              <td class="drivers-cell">Problema sin solución</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
            </tr>

            <!-- SERVICIO 3 -->
            <tr>
              <td class="tbl-name">
                Servicio 3
                <button class="plus-btn service-toggle" data-service="serv3" data-expanded="false">+</button>
              </td>
              <td class="drivers-cell">–</td>
              <td class="tbl-num">470</td>
              <td class="tbl-num">10,9%</td>
              <td class="tbl-num">52,0</td>
              <td class="tbl-num val-csat neg">3,90</td>
              <td class="tbl-num val-uplift neg">-0,20</td>
            </tr>
            <!-- Centro 2 -->
            <tr class="center-row" data-parent="serv3" style="display:none;">
              <td class="tbl-name center-cell">↳ Centro 2</td>
              <td class="drivers-cell">Logística / entrega</td>
              <td class="tbl-num">85</td>
              <td class="tbl-num">2,0%</td>
              <td class="tbl-num">48,0</td>
              <td class="tbl-num val-csat neg">3,70</td>
              <td class="tbl-num val-uplift neg">-0,40</td>
            </tr>
            <tr class="center-row driver-row" data-parent="serv3" style="display:none;">
              <td class="tbl-name center-cell-empty"></td>
              <td class="drivers-cell">Problema sin solución</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
              <td class="tbl-num">–</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="note-inline">
        Al presionar <span class="plus-btn" style="pointer-events:none;">+</span> se despliegan los centros asociados
        a cada servicio con sus métricas (NPS, comentarios, % sobre texto, CSAT, Uplift) y los drivers desagregados por fila.
      </div>
    </section>
  </div>

  <script>
    // -------------------- UTILIDADES --------------------
    function parseCellValue(text, type) {
      if (!text) return null;
      text = text.trim();
      if (text === '–' || text === '-' || text === '') return null;
      text = text.replace(/\s/g, '');

      if (type === 'int') {
        var cleanedInt = text.replace(/\./g, '');
        var intVal = parseInt(cleanedInt, 10);
        return isNaN(intVal) ? null : intVal;
      }

      if (type === 'percent') {
        var cleanedPct = text.replace('%', '').replace(/\./g, '').replace(',', '.');
        var pctVal = parseFloat(cleanedPct);
        return isNaN(pctVal) ? null : pctVal;
      }

      if (type === 'decimal') {
        var cleanedDec = text.replace('+', '').replace('–', '-').replace(',', '.');
        var decVal = parseFloat(cleanedDec);
        return isNaN(decVal) ? null : decVal;
      }
      return null;
    }

    function formatDecimal(value, decimals, withSign) {
      if (value === null || typeof value === 'undefined' || isNaN(value)) return '–';
      var fixed = value.toFixed(decimals);
      var out = fixed.replace('.', ',');
      if (withSign && value > 0) out = '+' + out;
      return out;
    }

    function getCsatClass(v) {
      if (v === null || isNaN(v)) return 'neutral';
      if (v >= 4.2) return 'pos';
      if (v <= 3.6) return 'neg';
      return 'neutral';
    }

    function getUpliftClass(v) {
      if (v === null || isNaN(v)) return 'neutral';
      if (v > 0.001) return 'pos';
      if (v < -0.001) return 'neg';
      return 'neutral';
    }

    // -------------------- TOGGLE SERVICIOS --------------------
    document.querySelectorAll('.service-toggle').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var sid = this.getAttribute('data-service');
        var expanded = this.getAttribute('data-expanded') === 'true';
        var rows = document.querySelectorAll("tr[data-parent='" + sid + "']");
        rows.forEach(function(row) {
          row.style.display = expanded ? 'none' : 'table-row';
        });
        this.textContent = expanded ? '+' : '–';
        this.setAttribute('data-expanded', expanded ? 'false' : 'true');
      });
    });

    // -------------------- ORDEN TABLA DRIVERS MACRO --------------------
    (function() {
      var table = document.getElementById('drivers-table');
      if (!table) return;

      table.querySelectorAll('thead th.sortable-col').forEach(function(th) {
        th.dataset.sortDirection = 'none';

        th.addEventListener('click', function() {
          var sortType = th.dataset.sortType || 'decimal';
          var colIndex = Array.prototype.indexOf.call(th.parentNode.children, th);
          var current  = th.dataset.sortDirection;
          var next     = current === 'asc' ? 'desc' : 'asc';
          th.dataset.sortDirection = next;
          var direction = next === 'asc' ? 1 : -1;

          table.querySelectorAll('thead th.sortable-col').forEach(function(other) {
            if (other !== th) {
              other.dataset.sortDirection = 'none';
              var io = other.querySelector('.sort-indicator');
              if (io) io.textContent = '↕';
            }
          });

          var icon = th.querySelector('.sort-indicator');
          if (icon) icon.textContent = next === 'asc' ? '▲' : '▼';

          var tbody = table.querySelector('tbody');
          var totalRow = tbody.querySelector('.row-total');
          var promRow  = tbody.querySelector('.row-prom');

          var dataRows = Array.from(tbody.querySelectorAll('tr')).filter(function(row) {
            return !row.classList.contains('row-total') && !row.classList.contains('row-prom');
          });

          dataRows.sort(function(rowA, rowB) {
            var textA = rowA.children[colIndex].textContent;
            var textB = rowB.children[colIndex].textContent;
            var valA  = parseCellValue(textA, sortType);
            var valB  = parseCellValue(textB, sortType);

            if (valA === null && valB === null) return 0;
            if (valA === null) return 1;
            if (valB === null) return -1;
            return (valA - valB) * direction;
          });

          tbody.innerHTML = '';
          dataRows.forEach(function(r) { tbody.appendChild(r); });
          if (totalRow) tbody.appendChild(totalRow);
          if (promRow)  tbody.appendChild(promRow);
        });
      });
    })();

    // -------------------- DATA DEMO DRIVERS MACRO POR AÑO --------------------
    var macroBase2024 = [
      { driver: 'Tiempos de espera',     comments: 980, csat: 3.60, uplift: -0.50 },
      { driver: 'Productos',             comments: 720, csat: 4.30, uplift:  0.20 },
      { driver: 'Logística / entrega',   comments: 610, csat: 3.90, uplift: -0.30 },
      { driver: 'Atención vendedor',     comments: 540, csat: 4.40, uplift:  0.30 },
      { driver: 'Atención repartidor',   comments: 380, csat: 4.00, uplift: -0.10 },
      { driver: 'Problema sin solución', comments: 430, csat: 3.10, uplift: -1.00 },
      { driver: 'Otros',                 comments: 420, csat: 4.00, uplift: -0.10 },
      { driver: 'En blanco',             comments: 240, csat: null, uplift: null }
    ];

    function shiftMacroData(base, factorComments, csatDelta, upliftDelta) {
      return base.map(function(row) {
        return {
          driver: row.driver,
          comments: Math.round(row.comments * factorComments),
          csat: (row.csat === null || typeof row.csat === 'undefined') ? null : row.csat + csatDelta,
          uplift: (row.uplift === null || typeof row.uplift === 'undefined') ? null : row.uplift + upliftDelta
        };
      });
    }

    var macroDataByYear = {
      2023: shiftMacroData(macroBase2024, 0.95, -0.05, -0.05),
      2024: macroBase2024,
      2025: shiftMacroData(macroBase2024, 1.05,  0.05,  0.05)
    };

    var globalCsatByYear = {
      2023: 4.00,
      2024: 4.10,
      2025: 4.20
    };

    var globalUpliftByYear = {
      2023: -0.05,
      2024:  0.00,
      2025:  0.05
    };

    function renderDriversMacro(year) {
      var tbody = document.querySelector('#drivers-table tbody');
      if (!tbody) return;

      var rowsData = macroDataByYear[year] || macroBase2024;
      var totalComments = rowsData.reduce(function(acc, row) {
        return acc + (row.comments || 0);
      }, 0);

      tbody.innerHTML = '';

      rowsData.forEach(function(row) {
        var tr = document.createElement('tr');

        var tdDriver = document.createElement('td');
        tdDriver.className = 'tbl-name';
        tdDriver.textContent = row.driver;
        tr.appendChild(tdDriver);

        var tdComments = document.createElement('td');
        tdComments.className = 'tbl-num';
        tdComments.textContent = totalComments
          ? new Intl.NumberFormat('es-CL').format(row.comments || 0)
          : '0';
        tr.appendChild(tdComments);

        var tdPct = document.createElement('td');
        tdPct.className = 'tbl-num';
        var pctVal = totalComments ? ((row.comments || 0) / totalComments * 100) : 0;
        tdPct.textContent = totalComments ? formatDecimal(pctVal, 1, false) + '%' : '0,0%';
        tr.appendChild(tdPct);

        var tdCsat = document.createElement('td');
        var csatVal = row.csat;
        tdCsat.className = 'tbl-num val-csat ' + getCsatClass(csatVal);
        tdCsat.textContent = (csatVal === null || typeof csatVal === 'undefined')
          ? '–'
          : formatDecimal(csatVal, 2, false);
        tr.appendChild(tdCsat);

        var tdU = document.createElement('td');
        var uVal = row.uplift;
        tdU.className = 'tbl-num val-uplift ' + getUpliftClass(uVal);
        tdU.textContent = (uVal === null || typeof uVal === 'undefined')
          ? '–'
          : formatDecimal(uVal, 2, true);
        tr.appendChild(tdU);

        tbody.appendChild(tr);
      });

      // Fila Totales
      var trTotal = document.createElement('tr');
      trTotal.className = 'row-total';

      var tdLabelTot = document.createElement('td');
      tdLabelTot.className = 'tbl-name';
      tdLabelTot.textContent = 'Totales';
      trTotal.appendChild(tdLabelTot);

      var tdCommTot = document.createElement('td');
      tdCommTot.className = 'tbl-num';
      tdCommTot.textContent = new Intl.NumberFormat('es-CL').format(totalComments);
      trTotal.appendChild(tdCommTot);

      var tdPctTot = document.createElement('td');
      tdPctTot.className = 'tbl-num';
      tdPctTot.textContent = totalComments ? '100,0%' : '0,0%';
      trTotal.appendChild(tdPctTot);

      var tdCsatTot = document.createElement('td');
      tdCsatTot.className = 'tbl-num';
      tdCsatTot.textContent = '–';
      trTotal.appendChild(tdCsatTot);

      var tdUpliftTot = document.createElement('td');
      tdUpliftTot.className = 'tbl-num';
      tdUpliftTot.textContent = '–';
      trTotal.appendChild(tdUpliftTot);

      tbody.appendChild(trTotal);

      // Fila Promedios (usa CSAT/Uplift global por año)
      var trProm = document.createElement('tr');
      trProm.className = 'row-prom';

      var tdLabelProm = document.createElement('td');
      tdLabelProm.className = 'tbl-name';
      tdLabelProm.textContent = 'Promedios';
      trProm.appendChild(tdLabelProm);

      var tdVoid1 = document.createElement('td');
      tdVoid1.className = 'tbl-num';
      tdVoid1.textContent = '–';
      trProm.appendChild(tdVoid1);

      var tdVoid2 = document.createElement('td');
      tdVoid2.className = 'tbl-num';
      tdVoid2.textContent = '–';
      trProm.appendChild(tdVoid2);

      var globalCsat = (globalCsatByYear[year] !== undefined) ? globalCsatByYear[year] : 4.10;
      var tdCsatProm = document.createElement('td');
      tdCsatProm.className = 'tbl-num val-csat ' + getCsatClass(globalCsat);
      tdCsatProm.textContent = formatDecimal(globalCsat, 2, false);
      trProm.appendChild(tdCsatProm);

      var globalUplift = (globalUpliftByYear[year] !== undefined) ? globalUpliftByYear[year] : 0.00;
      var tdUpliftProm = document.createElement('td');
      tdUpliftProm.className = 'tbl-num val-uplift ' + getUpliftClass(globalUplift);
      tdUpliftProm.textContent = formatDecimal(globalUplift, 2, false);
      trProm.appendChild(tdUpliftProm);

      tbody.appendChild(trProm);
    }

    // -------------------- DATA EVOLUCIÓN TRIMESTRAL --------------------
    var baseCsat2024 = [
      { driver: 'Tiempos de espera',     quarters: [3.5, 3.6, 3.7, 3.6] },
      { driver: 'Productos',             quarters: [4.2, 4.3, 4.4, 4.3] },
      { driver: 'Logística / entrega',   quarters: [3.8, 3.9, 4.0, 3.9] },
      { driver: 'Atención vendedor',     quarters: [4.3, 4.4, 4.5, 4.4] },
      { driver: 'Atención repartidor',   quarters: [3.9, 4.0, 4.1, 4.0] },
      { driver: 'Problema sin solución', quarters: [3.0, 3.1, 3.2, 3.1] },
      { driver: 'Otros',                 quarters: [3.9, 4.0, 4.1, 4.0] },
      { driver: 'En blanco',             quarters: [null, null, null, null] }
    ];

    var baseUplift2024 = [
      { driver: 'Tiempos de espera',     quarters: [-0.60, -0.50, -0.40, -0.50] },
      { driver: 'Productos',             quarters: [ 0.10,  0.20,  0.30,  0.20] },
      { driver: 'Logística / entrega',   quarters: [-0.40, -0.30, -0.20, -0.30] },
      { driver: 'Atención vendedor',     quarters: [ 0.20,  0.30,  0.40,  0.30] },
      { driver: 'Atención repartidor',   quarters: [-0.10, -0.10,  0.00, -0.10] },
      { driver: 'Problema sin solución', quarters: [-1.10, -1.00, -0.90, -1.00] },
      { driver: 'Otros',                 quarters: [-0.20, -0.10,  0.00, -0.10] },
      { driver: 'En blanco',             quarters: [0.00, 0.00, 0.00, 0.00] }
    ];

    function shiftQuarters(data, delta) {
      return data.map(function(row) {
        return {
          driver: row.driver,
          quarters: row.quarters.map(function(q) {
            if (q === null) return null;
            return q + delta;
          })
        };
      });
    }

    var csatDataByYear = {
      2023: shiftQuarters(baseCsat2024, -0.10),
      2024: baseCsat2024,
      2025: shiftQuarters(baseCsat2024,  0.10)
    };

    var upliftDataByYear = {
      2023: shiftQuarters(baseUplift2024, -0.05),
      2024: baseUplift2024,
      2025: shiftQuarters(baseUplift2024,  0.05)
    };

    function renderEvolutionTables(year) {
      var csatBody   = document.querySelector('.ranking-csat tbody');
      var upliftBody = document.querySelector('.ranking-uplift tbody');
      if (!csatBody || !upliftBody) return;

      var csatRows   = csatDataByYear[year]   || [];
      var upliftRows = upliftDataByYear[year] || [];

      csatBody.innerHTML = '';
      upliftBody.innerHTML = '';

      csatRows.forEach(function(row) {
        var tr = document.createElement('tr');

        var tdDriver = document.createElement('td');
        tdDriver.className = 'tbl-name';
        tdDriver.textContent = row.driver;
        tr.appendChild(tdDriver);

        var quarters = row.quarters;
        var sum = 0;
        var count = 0;

        quarters.forEach(function(q) {
          var td = document.createElement('td');
          var cls = 'tbl-num val-csat ' + getCsatClass(q);
          td.className = cls;
          td.textContent = q === null ? '–' : formatDecimal(q, 2, false);
          tr.appendChild(td);

          if (q !== null && !isNaN(q)) {
            sum += q;
            count++;
          }
        });

        var avg = count > 0 ? sum / count : null;
        var tdTotal = document.createElement('td');
        tdTotal.className = 'tbl-num val-csat ' + getCsatClass(avg);
        tdTotal.textContent = formatDecimal(avg, 2, false);
        tdTotal.setAttribute('data-total', 'true');
        tr.appendChild(tdTotal);

        csatBody.appendChild(tr);
      });

      upliftRows.forEach(function(row) {
        var tr = document.createElement('tr');

        var tdDriver = document.createElement('td');
        tdDriver.className = 'tbl-name';
        tdDriver.textContent = row.driver;
        tr.appendChild(tdDriver);

        var quarters = row.quarters;
        var sum = 0;
        var count = 0;

        quarters.forEach(function(q) {
          var td = document.createElement('td');
          var cls = 'tbl-num val-uplift ' + getUpliftClass(q);
          td.className = cls;
          td.textContent = q === null ? '–' : formatDecimal(q, 2, true);
          tr.appendChild(td);

          if (q !== null && !isNaN(q)) {
            sum += q;
            count++;
          }
        });

        var avg = count > 0 ? sum / count : null;
        var tdTotal = document.createElement('td');
        tdTotal.className = 'tbl-num val-uplift ' + getUpliftClass(avg);
        tdTotal.textContent = formatDecimal(avg, 2, true);
        tdTotal.setAttribute('data-total', 'true');
        tr.appendChild(tdTotal);

        upliftBody.appendChild(tr);
      });
    }

    // -------------------- ORDEN EVOLUCIÓN (CSAT / UPLIFT) --------------------
    (function() {
      var rankingTables = document.querySelectorAll('.ranking-table');
      rankingTables.forEach(function(table) {
        var tbody = table.querySelector('tbody');

        table.querySelectorAll('thead th.sortable-col').forEach(function(th) {
          th.dataset.sortDirection = 'none';

          th.addEventListener('click', function() {
            var sortType = th.dataset.sortType || 'decimal';
            var colIndex = Array.prototype.indexOf.call(th.parentNode.children, th);
            var current  = th.dataset.sortDirection;
            var next     = current === 'asc' ? 'desc' : 'asc';
            th.dataset.sortDirection = next;
            var direction = next === 'asc' ? 1 : -1;

            table.querySelectorAll('thead th.sortable-col').forEach(function(other) {
              if (other !== th) {
                other.dataset.sortDirection = 'none';
                var io = other.querySelector('.sort-indicator');
                if (io) io.textContent = '↕';
              }
            });

            var icon = th.querySelector('.sort-indicator');
            if (icon) icon.textContent = next === 'asc' ? '▲' : '▼';

            var dataRows = Array.from(tbody.querySelectorAll('tr'));

            dataRows.sort(function(rowA, rowB) {
              var textA = rowA.children[colIndex].textContent;
              var textB = rowB.children[colIndex].textContent;
              var valA  = parseCellValue(textA, sortType);
              var valB  = parseCellValue(textB, sortType);

              if (valA === null && valB === null) return 0;
              if (valA === null) return 1;
              if (valB === null) return -1;
              return (valA - valB) * direction;
            });

            tbody.innerHTML = '';
            dataRows.forEach(function(r) { tbody.appendChild(r); });
          });
        });
      });
    })();

    // -------------------- INICIALIZACIÓN --------------------
    var yearSelect = document.getElementById('year-select');
    if (yearSelect) {
      renderDriversMacro(yearSelect.value);
      renderEvolutionTables(yearSelect.value);

      yearSelect.addEventListener('change', function() {
        renderDriversMacro(this.value);
        renderEvolutionTables(this.value);
      });
    }
  </script>
</body>
</html>
