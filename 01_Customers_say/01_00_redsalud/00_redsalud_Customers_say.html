<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CXDIP · Customers Say - RedSalud IBB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #f5f7fb; --card: #ffffff; --border: #e2e8f0;
      --text-main: #0f172a; --text-muted: #64748b;
      --accent: #2563eb; --accent-soft: #38bdf8;
      --accent-good: #16a34a; --accent-bad: #ef4444;
      --radius-card: 16px;
    }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; padding: 0; background: var(--bg); color: var(--text-main); }
    .page { max-width: 1320px; margin: 0 auto; padding: 24px 18px 40px; }
    
    header { margin-bottom: 20px; }
    .title-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 20px; }
    .title-main { font-size: 1.9rem; font-weight: 700; letter-spacing: -0.02em; }
    .title-main span { color: var(--accent); }
    .badge-secondary { padding: 6px 10px; border-radius: 99px; background: #e0f2fe; color: #0369a1; font-size: 0.75rem; font-weight: 500; }

    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; margin-top: 18px; }
    .summary-card { background: var(--card); border-radius: var(--radius-card); padding: 16px; border: 1px solid var(--border); }
    .summary-label { font-size: 0.8rem; color: var(--text-muted); }
    .summary-value { font-size: 1.5rem; font-weight: 600; margin-top: 4px; }

    .card { background: var(--card); border-radius: var(--radius-card); padding: 20px; border: 1px solid var(--border); margin-top: 18px; }
    .section-title { margin-top: 30px; font-size: 0.9rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
    
    .filter-row { display: flex; align-items: center; gap: 10px; margin: 15px 0; }
    .trim-pills { display: inline-flex; gap: 5px; }
    .trim-pill { border: 1px solid #c7d2fe; background: #e5edff; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; user-select: none; transition: 0.2s; }
    .trim-pill:hover { background: #dbeafe; }
    .trim-pill.selected { background: var(--accent); color: #fff; border-color: var(--accent); }

    .table-wrapper { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 700px; }
    th { text-align: left; padding: 10px; border-bottom: 2px solid #e2e8f0; color: var(--text-muted); font-weight: 600; cursor: pointer; }
    td { padding: 10px; border-bottom: 1px solid #e2e8f0; }
    .tbl-num { text-align: right; font-variant-numeric: tabular-nums; }
    .tbl-name { font-weight: 500; }
    
    .pos { color: var(--accent-good); font-weight: 600; }
    .neg { color: var(--accent-bad); font-weight: 600; }
    .neu { color: var(--accent); }

    /* Hierarchy Styles */
    .service-row td { background-color: #f8fafc; font-weight: 600; border-bottom: 2px solid #cbd5e1; }
    .center-row td:first-child { padding-left: 30px; color: #334155; }
    .driver-row td:first-child { padding-left: 60px; font-style: italic; color: #64748b; font-size: 0.8rem; }
    
    .plus-btn { display: inline-flex; width: 18px; height: 18px; border-radius: 4px; background: #eff6ff; color: var(--accent); border: 1px solid #bfdbfe; align-items: center; justify-content: center; margin-left: 8px; cursor: pointer; font-size: 12px; line-height: 1; }
    .plus-btn:hover { background: #dbeafe; }

    /* Ranking Table specific */
    .ranking-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 15px; }
    .ranking-card { background: #f9fafb; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; }
    .table-wrapper-ranking { max-height: 200px; overflow-y: auto; }
    .table-wrapper-ranking th { position: sticky; top: 0; background: #f9fafb; z-index: 10; }

    @media (max-width: 768px) { .ranking-row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<div class="page">
  <div class="title-row">
    <div class="title-main"><span>CXDIP</span> Customers Say</div>
    <div class="badge-secondary">ETL Data 2025</div>
  </div>

  <div class="summary-grid">
    <div class="summary-card">
      <div class="summary-label">Total Comentarios (Filtro)</div>
      <div class="summary-value" id="kpi-comments">--</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">IBB Global (Filtro)</div>
      <div class="summary-value" id="kpi-ibb">--</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">Atributos Detectados</div>
      <div class="summary-value" id="kpi-attrs">--</div>
    </div>
  </div>

  <section class="card">
    <h2>Drivers Macro</h2>
    <div class="card-subtitle">Visión anual consolidada</div>
    <div class="table-wrapper">
      <table id="drivers-table">
        <thead>
          <tr>
            <th>Atributo</th>
            <th class="tbl-num">N° Comentarios</th>
            <th class="tbl-num">% del Total</th>
            <th class="tbl-num">IBB</th>
            <th class="tbl-num">Uplift</th>
          </tr>
        </thead>
        <tbody id="tbody-drivers"></tbody>
      </table>
    </div>

    <div class="ranking-row">
      <div class="ranking-card">
        <h3 style="font-size:0.9rem; margin:0 0 10px 0;">Evolución IBB</h3>
        <div class="table-wrapper-ranking">
          <table class="ranking-table">
            <thead id="head-evo-ibb"></thead>
            <tbody id="body-evo-ibb"></tbody>
          </table>
        </div>
      </div>
      <div class="ranking-card">
        <h3 style="font-size:0.9rem; margin:0 0 10px 0;">Evolución Uplift</h3>
        <div class="table-wrapper-ranking">
          <table class="ranking-table">
            <thead id="head-evo-up"></thead>
            <tbody id="body-evo-up"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <div class="section-title">SERVICIOS AGREGADOS (FILTRABLE)</div>
  <section class="card">
    <div class="filter-row">
      <span style="font-size:0.85rem; color:#64748b; font-weight:600;">Trimestres:</span>
      <div class="trim-pills">
        <div class="trim-pill selected" onclick="toggleTrim(1)">T1</div>
        <div class="trim-pill selected" onclick="toggleTrim(2)">T2</div>
        <div class="trim-pill selected" onclick="toggleTrim(3)">T3</div>
        <div class="trim-pill selected" onclick="toggleTrim(4)">T4</div>
      </div>
      <span style="font-size:0.75rem; color:#94a3b8; margin-left:10px;">Selecciona para recalcular métricas.</span>
    </div>

    <div class="table-wrapper">
      <table id="services-table">
        <thead>
          <tr>
            <th onclick="sortServices(0, 'str')">Servicio / Centro / Driver ↕</th>
            <th class="tbl-num" onclick="sortServices(1, 'num')">N° Comentarios ↕</th>
            <th class="tbl-num" onclick="sortServices(2, 'pct')">% Sobre Texto ↕</th>
            <th class="tbl-num" onclick="sortServices(3, 'num')">IBB ↕</th>
            <th class="tbl-num" onclick="sortServices(4, 'num')">Uplift ↕</th>
          </tr>
        </thead>
        <tbody id="tbody-services"></tbody>
      </table>
    </div>
    <div class="note-inline" style="margin-top:10px; font-size:0.75rem; color:#64748b;">
      * Haz clic en los encabezados para ordenar los Servicios. Al abrir (+) Centros y Drivers, estos se muestran ordenados por N° Comentarios (Mayor a Menor).
    </div>
  </section>
</div>

<script>
// --- ESTADO ---
let RAW_DATA = null;
let SELECTED_TRIMS = [1, 2, 3, 4];
let CURRENT_SORT = { col: 1, dir: 'desc' }; // Default: Ordenar Servicios por N° Comentarios Desc

// --- CARGA ---
document.addEventListener('DOMContentLoaded', async () => {
  try {
    // Cache buster para forzar recarga del JSON nuevo
    const res = await fetch('./data_redsalud.json?v=' + new Date().getTime());
    if(!res.ok) throw new Error("Error HTTP");
    RAW_DATA = await res.json();
    console.log("JSON Cargado", RAW_DATA);
    
    renderDriversMacro();
    renderEvolution();
    renderServicesTable();
  } catch(e) {
    console.error(e);
    document.getElementById('kpi-ibb').textContent = "Error Carga";
    alert("No se pudo cargar data_redsalud.json. Asegúrate de haber ejecutado el nuevo ETL.");
  }
});

// --- RENDER DRIVERS MACRO ---
function renderDriversMacro() {
  if(!RAW_DATA) return;
  const tbody = document.getElementById('tbody-drivers');
  tbody.innerHTML = '';
  const data = RAW_DATA.drivers_macro || [];
  const total = data.reduce((sum, r) => sum + r.count, 0);

  // Ordenar por IBB ascendente (problemas primero)
  data.sort((a,b) => a.ibb - b.ibb);

  data.forEach(r => {
    tbody.innerHTML += `
      <tr>
        <td class="tbl-name">${r.attribute}</td>
        <td class="tbl-num">${fmt(r.count)}</td>
        <td class="tbl-num">${fmtPct(r.count/total*100)}</td>
        <td class="tbl-num ${getCls(r.ibb)}">${fmtDec(r.ibb)}</td>
        <td class="tbl-num ${getClsUp(r.uplift)}">${fmtDec(r.uplift, true)}</td>
      </tr>
    `;
  });
}

// --- RENDER EVOLUCION ---
function renderEvolution() {
  if(!RAW_DATA) return;
  const ibbRows = RAW_DATA.evolution_ibb || [];
  const upRows = RAW_DATA.evolution_uplift || [];
  
  // Headers
  const quarters = ibbRows.map(r => r.trimestre.split('-')[1]).filter((v,i,a)=>a.indexOf(v)===i).sort();
  const headI = document.getElementById('head-evo-ibb');
  const headU = document.getElementById('head-evo-up');
  
  let hHTML = '<tr><th>Driver</th>' + quarters.map(q => `<th class="tbl-num">${q}</th>`).join('') + '<th class="tbl-num">Total</th></tr>';
  headI.innerHTML = hHTML;
  headU.innerHTML = hHTML;

  const bodyI = document.getElementById('body-evo-ibb');
  const bodyU = document.getElementById('body-evo-up');
  bodyI.innerHTML = ''; bodyU.innerHTML = '';

  const attrs = RAW_DATA.drivers_macro.map(d => d.attribute);

  attrs.forEach(attr => {
    const annual = RAW_DATA.drivers_macro.find(d => d.attribute === attr);
    
    // IBB Row
    let rowI = `<tr><td class="tbl-name">${attr}</td>`;
    quarters.forEach(q => {
      const rec = ibbRows.find(r => r.trimestre.endsWith(q));
      const val = rec ? rec[attr] : null;
      rowI += `<td class="tbl-num ${getCls(val)}">${fmtDec(val)}</td>`;
    });
    rowI += `<td class="tbl-num ${getCls(annual.ibb)}"><b>${fmtDec(annual.ibb)}</b></td></tr>`;
    bodyI.innerHTML += rowI;

    // Uplift Row
    let rowU = `<tr><td class="tbl-name">${attr}</td>`;
    quarters.forEach(q => {
      const rec = upRows.find(r => r.trimestre.endsWith(q));
      const val = rec ? rec[attr] : null;
      rowU += `<td class="tbl-num ${getClsUp(val)}">${fmtDec(val, true)}</td>`;
    });
    rowU += `<td class="tbl-num ${getClsUp(annual.uplift)}"><b>${fmtDec(annual.uplift, true)}</b></td></tr>`;
    bodyU.innerHTML += rowU;
  });
}

// --- LOGICA PRINCIPAL: SERVICIOS AGREGADOS ---

function toggleTrim(t) {
  const idx = SELECTED_TRIMS.indexOf(t);
  if(idx > -1) {
    if(SELECTED_TRIMS.length > 1) SELECTED_TRIMS.splice(idx, 1);
  } else {
    SELECTED_TRIMS.push(t);
  }
  // Update Pills UI
  document.querySelectorAll('.trim-pill').forEach((el, i) => {
    el.classList.toggle('selected', SELECTED_TRIMS.includes(i+1));
  });
  renderServicesTable();
}

function sortServices(colIdx, type) {
  if(CURRENT_SORT.col === colIdx) {
    CURRENT_SORT.dir = CURRENT_SORT.dir === 'asc' ? 'desc' : 'asc';
  } else {
    CURRENT_SORT.col = colIdx;
    CURRENT_SORT.dir = 'desc'; // Default desc for numbers
    if(colIdx === 0) CURRENT_SORT.dir = 'asc';
  }
  renderServicesTable();
}

function renderServicesTable() {
  if(!RAW_DATA) return;
  const centersData = RAW_DATA.services_breakdown.Centers || [];
  
  // 1. AGREGACIÓN (Calculando métricas basadas en SELECTED_TRIMS)
  // Estructura: aggData[Service] -> { centers: { Center: { drivers: { Driver: Stats } } } }
  
  let aggData = {};
  let totalComments = 0;
  let weightedIBBGlobal = 0;
  let uniqueDrivers = new Set();

  centersData.forEach(center => {
    center.services.forEach(service => {
      service.attributes.forEach(attr => {
        // Parse "2025-T1" -> 1
        let q = 0;
        if(attr.trimestre) q = parseInt(attr.trimestre.split('-')[1].replace('T',''));
        
        // Filtro estricto: Si hay trimestre, debe coincidir. Si no hay (data vieja), asumimos T1-T4 match.
        if(q > 0 && !SELECTED_TRIMS.includes(q)) return;

        // Acumular
        totalComments += attr.count;
        weightedIBBGlobal += (attr.count * attr.ibb);
        uniqueDrivers.add(attr.attribute);

        // Nivel Servicio
        if(!aggData[service.service]) aggData[service.service] = { count:0, w_ibb:0, centers:{} };
        let sNode = aggData[service.service];
        sNode.count += attr.count;
        sNode.w_ibb += (attr.count * attr.ibb);

        // Nivel Centro
        if(!sNode.centers[center.center]) sNode.centers[center.center] = { count:0, w_ibb:0, drivers:{} };
        let cNode = sNode.centers[center.center];
        cNode.count += attr.count;
        cNode.w_ibb += (attr.count * attr.ibb);

        // Nivel Driver
        if(!cNode.drivers[attr.attribute]) cNode.drivers[attr.attribute] = { count:0, w_ibb:0 };
        let dNode = cNode.drivers[attr.attribute];
        dNode.count += attr.count;
        dNode.w_ibb += (attr.count * attr.ibb);
      });
    });
  });

  // KPIs
  const globalIBB = totalComments > 0 ? weightedIBBGlobal/totalComments : 0;
  document.getElementById('kpi-comments').innerText = fmt(totalComments);
  document.getElementById('kpi-ibb').innerText = fmtDec(globalIBB);
  document.getElementById('kpi-ibb').className = 'summary-value ' + getCls(globalIBB);
  document.getElementById('kpi-attrs').innerText = uniqueDrivers.size;

  // 2. CONVERTIR A ARRAY PARA ORDENAR
  let servicesArr = Object.keys(aggData).map(sName => {
    let s = aggData[sName];
    let ibb = s.count > 0 ? s.w_ibb/s.count : 0;
    
    // Procesar Centros
    let centersArr = Object.keys(s.centers).map(cName => {
      let c = s.centers[cName];
      let c_ibb = c.count > 0 ? c.w_ibb/c.count : 0;
      
      // Procesar Drivers
      let driversArr = Object.keys(c.drivers).map(dName => {
        let d = c.drivers[dName];
        let d_ibb = d.count > 0 ? d.w_ibb/d.count : 0;
        return {
          name: dName, count: d.count, ibb: d_ibb, 
          uplift: d_ibb - globalIBB, pct: d.count/totalComments*100
        };
      });
      // ORDENAR DRIVERS (Siempre por N° Comentarios DESC)
      driversArr.sort((a,b) => b.count - a.count);

      return {
        name: cName, count: c.count, ibb: c_ibb, 
        uplift: c_ibb - globalIBB, pct: c.count/totalComments*100,
        drivers: driversArr
      };
    });
    // ORDENAR CENTROS (Siempre por N° Comentarios DESC)
    centersArr.sort((a,b) => b.count - a.count);

    return {
      name: sName, count: s.count, ibb: ibb, 
      uplift: ibb - globalIBB, pct: s.count/totalComments*100,
      centers: centersArr
    };
  });

  // 3. APLICAR SORT PRINCIPAL (SERVICIOS)
  const { col, dir } = CURRENT_SORT;
  servicesArr.sort((a,b) => {
    let valA, valB;
    if(col===0) { valA=a.name; valB=b.name; }
    else if(col===1) { valA=a.count; valB=b.count; }
    else if(col===2) { valA=a.pct; valB=b.pct; }
    else if(col===3) { valA=a.ibb; valB=b.ibb; }
    else { valA=a.uplift; valB=b.uplift; }

    if(valA < valB) return dir==='asc' ? -1 : 1;
    if(valA > valB) return dir==='asc' ? 1 : -1;
    return 0;
  });

  // 4. GENERAR HTML
  const tbody = document.getElementById('tbody-services');
  tbody.innerHTML = '';
  
  if(servicesArr.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No hay datos para esta selección.</td></tr>';
    return;
  }

  servicesArr.forEach(s => {
    // S-Key seguro
    const sId = 's-' + s.name.replace(/[^a-zA-Z0-9]/g, '');
    
    // Row Servicio
    tbody.innerHTML += `
      <tr class="service-row">
        <td>${s.name} <div class="plus-btn" onclick="toggle('${sId}', this)">+</div></td>
        <td class="tbl-num">${fmt(s.count)}</td>
        <td class="tbl-num">${fmtPct(s.pct)}</td>
        <td class="tbl-num ${getCls(s.ibb)}">${fmtDec(s.ibb)}</td>
        <td class="tbl-num ${getClsUp(s.uplift)}">${fmtDec(s.uplift, true)}</td>
      </tr>
    `;

    s.centers.forEach(c => {
      const cId = sId + '-c-' + c.name.replace(/[^a-zA-Z0-9]/g, '');
      // Row Centro
      tbody.innerHTML += `
        <tr class="center-row ${sId}" style="display:none;">
          <td><span class="tbl-name">${c.name}</span> <div class="plus-btn" onclick="toggle('${cId}', this)">+</div></td>
          <td class="tbl-num">${fmt(c.count)}</td>
          <td class="tbl-num">${fmtPct(c.pct)}</td>
          <td class="tbl-num ${getCls(c.ibb)}">${fmtDec(c.ibb)}</td>
          <td class="tbl-num ${getClsUp(c.uplift)}">${fmtDec(c.uplift, true)}</td>
        </tr>
      `;

      c.drivers.forEach(d => {
        // Row Driver
        tbody.innerHTML += `
          <tr class="driver-row ${cId} ${sId}" style="display:none;">
            <td><span class="tbl-name">${d.name}</span></td>
            <td class="tbl-num">${fmt(d.count)}</td>
            <td class="tbl-num">${fmtPct(d.pct)}</td>
            <td class="tbl-num ${getCls(d.ibb)}">${fmtDec(d.ibb)}</td>
            <td class="tbl-num ${getClsUp(d.uplift)}">${fmtDec(d.uplift, true)}</td>
          </tr>
        `;
      });
    });
  });
}

// --- TOGGLE HELPER ---
function toggle(targetClass, btn) {
  const rows = document.getElementsByClassName(targetClass);
  const isExpand = btn.innerText === '+';
  btn.innerText = isExpand ? '–' : '+';
  
  Array.from(rows).forEach(row => {
    if(isExpand) {
      row.style.display = 'table-row';
    } else {
      row.style.display = 'none';
      // Si cierro, también debo cerrar los hijos recursivamente si existen botones abiertos dentro
      if(row.classList.contains('center-row')) {
         // Buscar el botón dentro de esta fila
         let childBtn = row.querySelector('.plus-btn');
         if(childBtn && childBtn.innerText === '–') {
            // Forzar click para cerrar hijos
            childBtn.click();
         }
      }
    }
  });
}

// --- FORMATTERS ---
function fmt(n) { return new Intl.NumberFormat('es-CL').format(n); }
function fmtDec(n, sign=false) { 
  if(n===undefined || n===null) return '-'; 
  let s = n.toFixed(2).replace('.',','); 
  if(sign && n>0) s = '+'+s; 
  return s; 
}
function fmtPct(n) { return n.toFixed(1).replace('.',',') + '%'; }
function getCls(n) { if(n>=10) return 'pos'; if(n<=-10) return 'neg'; return 'neu'; }
function getClsUp(n) { if(n>0) return 'pos'; if(n<0) return 'neg'; return 'neu'; }

</script>
</body>
</html>
