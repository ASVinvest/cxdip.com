<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>CXDIP ¬∑ Panel Customers say 2025 (Demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Panel CXDIP Customers say RedSalud" />

  <style>
    :root {
      --bg-page: #f5f7fb;
      --bg-card: #ffffff;
      --primary: #246bff;
      --accent: #10b981;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-subtle: #e5e7eb;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg-page);
      color: var(--text-main);
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    .page-header {
      margin-bottom: 18px;
    }

    .page-header h1 {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.06);
    }

    .card p.label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .card h2.kpi-value {
      font-size: 1.9rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .card small {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .section-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 18px 20px 20px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.06);
      margin-bottom: 20px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .section-title {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .section-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .toggle-year {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .toggle-pill {
      width: 40px;
      height: 22px;
      border-radius: 999px;
      background: #dbeafe;
      padding: 2px;
      display: flex;
      justify-content: flex-end;
    }

    .toggle-knob {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--primary);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }

    thead {
      background: #f9fafb;
    }

    th,
    td {
      padding: 8px 6px;
      border-bottom: 1px solid var(--border-subtle);
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .grid-evolucion {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .grid-evolucion .card {
      box-shadow: none;
      border-radius: 12px;
      border: 1px solid #edf2ff;
      padding: 14px 14px 10px;
    }

    .grid-evolucion h4 {
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    .servicios-header {
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    .servicios-note {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    #error-carga {
      display: none;
      color: #b91c1c;
      font-size: 0.75rem;
      margin-top: 6px;
    }

    @media (max-width: 768px) {
      main {
        padding-inline: 12px;
      }

      th,
      td {
        padding-inline: 4px;
      }
    }
  </style>
</head>
<body>
  <main>
    <header class="page-header">
      <h1>Procesamiento de texto abierto.</h1>
    </header>

    <!-- KPIs superiores -->
    <section class="kpi-grid">
      <div class="card">
        <p class="label">Total de respuestas</p>
        <h2 class="kpi-value" id="kpi-total-respuestas">‚Äì</h2>
      </div>

      <div class="card">
        <p class="label">Respuestas con comentario</p>
        <h2 class="kpi-value" id="kpi-respuestas-comentario">‚Äì</h2>
      </div>

      <div class="card">
        <p class="label">CSAT global (texto)</p>
        <h2 class="kpi-value" id="kpi-csat-global">‚Äì</h2>
        <small>Escala 1‚Äì5 ¬∑ s√≥lo casos con comentario</small>
      </div>
    </section>

    <!-- DRIVERS MACRO -->
    <section class="section-card">
      <div class="section-header">
        <div>
          <h2 class="section-title">Drivers Macro</h2>
          <p class="section-subtitle">Tabla consolidada por atributo</p>
        </div>
        <div class="toggle-year">
          <span>Selecciona el a√±o que quieres analizar:</span>
          <div class="toggle-pill" title="Selector de a√±o (demo)">
            <div class="toggle-knob"></div>
          </div>
        </div>
      </div>

      <!-- Tabla resumen de atributos -->
      <table>
        <thead>
          <tr>
            <th>Atributos macro</th>
            <th>N¬∫ comentarios</th>
            <th>% sobre texto</th>
            <th>CSAT atributo</th>
            <th>Uplift atributo</th>
          </tr>
        </thead>
        <tbody id="tbody-drivers-macro">
          <tr>
            <td colspan="5">Cargando‚Ä¶</td>
          </tr>
        </tbody>
      </table>

      <!-- Evoluciones -->
      <div class="grid-evolucion">
        <div class="card">
          <h4>Evoluci√≥n CSAT atributo</h4>
          <p class="section-subtitle">Evoluci√≥n del CSAT por atributo.</p>
          <table>
            <thead>
              <tr>
                <th>Driver</th>
                <th>T1</th>
                <th>T2</th>
                <th>T3</th>
                <th>T4</th>
                <th>Total anual</th>
              </tr>
            </thead>
            <tbody id="tbody-evol-csat">
              <tr>
                <td colspan="6">Cargando‚Ä¶</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="card">
          <h4>Evoluci√≥n Uplift atributo</h4>
          <p class="section-subtitle">Evoluci√≥n del Uplift por atributo.</p>
          <table>
            <thead>
              <tr>
                <th>Driver</th>
                <th>T1</th>
                <th>T2</th>
                <th>T3</th>
                <th>T4</th>
                <th>Total anual</th>
              </tr>
            </thead>
            <tbody id="tbody-evol-uplift">
              <tr>
                <td colspan="6">Cargando‚Ä¶</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SERVICIOS AGREGADOS -->
    <section class="section-card">
      <h2 class="section-title">SERVICIOS AGREGADOS</h2>
      <p class="servicios-header">Vista por servicio (apertura con ‚Äú+‚Äù).</p>
      <p class="servicios-note">
        Al presionar ‚Äú+‚Äù se despliegan los centros asociados a cada servicio con sus m√©tricas (NPS, comentarios, % sobre texto, CSAT, Uplift) y los drivers desagregados por fila.
      </p>

      <table>
        <thead>
          <tr>
            <th>Servicio / Centro</th>
            <th>Atributos mencionados</th>
            <th>N¬∫ comentarios</th>
            <th>% sobre texto</th>
            <th>NPS</th>
            <th>CSAT atributo</th>
            <th>Uplift atributo</th>
          </tr>
        </thead>
        <tbody id="tbody-servicios-agregados">
          <tr>
            <td colspan="7">Cargando‚Ä¶</td>
          </tr>
        </tbody>
      </table>

      <span id="error-carga"></span>
    </section>
  </main>

  <script>
    // üîß AJUSTA ESTA RUTA a tu JSON real de customers_say de RedSalud
    // por ejemplo: './data/customers_say_redsalud.json'
    const DATA_URL = './data/customers_say_redsalud.json';

    function formatNum(value) {
      if (value == null) return '‚Äì';
      return Number(value).toLocaleString('es-CL');
    }

    function formatPerc(value) {
      if (value == null) return '‚Äì';
      return Number(value).toFixed(1) + ' %';
    }

    function formatCsat(value) {
      if (value == null) return '‚Äì';
      return Number(value).toFixed(2);
    }

    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    function buildTable(tbodyId, rows, columnFns) {
      const tbody = document.getElementById(tbodyId);
      if (!tbody) return;

      tbody.innerHTML = '';

      if (!rows || !rows.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = columnFns.length;
        td.textContent = 'Sin datos';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      rows.forEach(row => {
        const tr = document.createElement('tr');
        columnFns.forEach(fn => {
          const td = document.createElement('td');
          td.textContent = fn(row);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    fetch(DATA_URL)
      .then(response => {
        if (!response.ok) {
          throw new Error('HTTP ' + response.status + ' al leer ' + DATA_URL);
        }
        return response.json();
      })
      .then(data => {
        console.log('JSON customers_say cargado:', data);

        // ‚ñ∏ KPIs superiores
        const kpis = data.kpis || data.kpi_texto || data;

        const totalRespuestas =
          kpis.total_respuestas_texto ??
          kpis.total_respuestas ??
          kpis.totalRespuestas ??
          null;

        const respuestasConComentario =
          kpis.respuestas_con_comentario ??
          kpis.resp_con_comentario ??
          kpis.respuestasComentario ??
          null;

        const csatGlobalTexto =
          kpis.csat_global_texto ??
          kpis.csat_global ??
          kpis.csat ??
          null;

        setText(
          'kpi-total-respuestas',
          totalRespuestas != null ? formatNum(totalRespuestas) : '‚Äì'
        );
        setText(
          'kpi-respuestas-comentario',
          respuestasConComentario != null
            ? formatNum(respuestasConComentario)
            : '‚Äì'
        );
        setText(
          'kpi-csat-global',
          csatGlobalTexto != null ? formatCsat(csatGlobalTexto) : '‚Äì'
        );

        // ‚ñ∏ Drivers macro
        const drivers =
          data.drivers_macro ||
          data.driversMacro ||
          data.drivers ||
          [];

        buildTable('tbody-drivers-macro', drivers, [
          r => r.atributo_macro || r.driver || r.nombre || '‚Äî',
          r => r.num_comentarios ?? r.comentarios ?? '‚Äî',
          r =>
            r.porcentaje_sobre_texto != null
              ? formatPerc(r.porcentaje_sobre_texto)
              : r.porc_texto != null
              ? formatPerc(r.porc_texto)
              : '‚Äî',
          r =>
            r.csat_atributo != null
              ? formatCsat(r.csat_atributo)
              : r.csat != null
              ? formatCsat(r.csat)
              : '‚Äî',
          r => r.uplift_atributo ?? r.uplift ?? '‚Äî'
        ]);

        // ‚ñ∏ Evoluci√≥n CSAT por atributo
        const evolCsat =
          data.evolucion_csat_atributo ||
          data.evolucion_csat ||
          [];

        buildTable('tbody-evol-csat', evolCsat, [
          r => r.driver || r.atributo || '‚Äî',
          r => r.T1 ?? r.t1 ?? '‚Äî',
          r => r.T2 ?? r.t2 ?? '‚Äî',
          r => r.T3 ?? r.t3 ?? '‚Äî',
          r => r.T4 ?? r.t4 ?? '‚Äî',
          r => r.total_anual ?? r.total ?? '‚Äî'
        ]);

        // ‚ñ∏ Evoluci√≥n Uplift por atributo
        const evolUplift =
          data.evolucion_uplift_atributo ||
          data.evolucion_uplift ||
          [];

        buildTable('tbody-evol-uplift', evolUplift, [
          r => r.driver || r.atributo || '‚Äî',
          r => r.T1 ?? r.t1 ?? '‚Äî',
          r => r.T2 ?? r.t2 ?? '‚Äî',
          r => r.T3 ?? r.t3 ?? '‚Äî',
          r => r.T4 ?? r.t4 ?? '‚Äî',
          r => r.total_anual ?? r.total ?? '‚Äî'
        ]);

        // ‚ñ∏ Servicios agregados
        const servicios =
          data.servicios_agregados ||
          data.servicios ||
          [];

        buildTable('tbody-servicios-agregados', servicios, [
          r => r.servicio || r.centro || r.nombre || '‚Äî',
          r => r.atributos_mencionados ?? r.atributos ?? '‚Äî',
          r => r.num_comentarios ?? r.comentarios ?? '‚Äî',
          r =>
            r.porcentaje_sobre_texto != null
              ? formatPerc(r.porcentaje_sobre_texto)
              : r.porc_texto != null
              ? formatPerc(r.porc_texto)
              : '‚Äî',
          r => r.nps ?? r.NPS ?? '‚Äî',
          r =>
            r.csat_atributo != null
              ? formatCsat(r.csat_atributo)
              : r.csat != null
              ? formatCsat(r.csat)
              : '‚Äî',
          r => r.uplift_atributo ?? r.uplift ?? '‚Äî'
        ]);
      })
      .catch(error => {
        console.error('Error cargando JSON de customers_say:', error);
        const errEl = document.getElementById('error-carga');
        if (errEl) {
          errEl.textContent =
            'Error al cargar datos de texto abierto (' + error.message + ')';
          errEl.style.display = 'inline';
        }
      });
  </script>
</body>
</html>
