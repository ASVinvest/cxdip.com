<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CXDIP · Customers Say</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --border: #e2e8f0;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --accent: #2563eb;
      --accent-soft: #38bdf8;
      --accent-good: #16a34a;
      --accent-bad: #ef4444;
      --radius-card: 16px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.06);
    }

    * {
      box-sizing: border-box;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text-main);
    }

    .page {
      max-width: 1320px;
      margin: 0 auto;
      padding: 24px 18px 40px;
    }

    header {
      margin-bottom: 20px;
    }

    .title-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .title-main {
      font-size: 1.9rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .title-main span {
      color: var(--accent);
    }

    .title-sub {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .badge-secondary {
      padding: 6px 10px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-top: 18px;
    }

    .summary-card {
      background: var(--card);
      border-radius: var(--radius-card);
      padding: 14px 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
    }

    .summary-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 1.35rem;
      font-weight: 600;
    }

    .summary-foot {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-card);
      padding: 16px 18px 18px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      margin-top: 18px;
    }

    .card h2 {
      margin: 0 0 8px;
      font-size: 1.05rem;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    /* Fila de filtros (año, trimestres) */
    .filter-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin: 6px 0 10px;
    }

    .filter-label {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .filter-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .year-select {
      padding: 4px 16px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: var(--accent);
      font-size: 0.8rem;
      color: #ffffff;
      font-weight: 600;
      outline: none;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    .year-select:hover {
      background: #1d4ed8;
      border-color: #1d4ed8;
    }

    /* Píldoras de trimestres */
    .trim-pills {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .trim-pill {
      border-radius: 999px;
      border: 1px solid #c7d2fe;
      background: #e5edff;
      padding: 3px 10px;
      font-size: 0.78rem;
      color: var(--text-muted);
      cursor: pointer;
      user-select: none;
    }

    .trim-pill.selected {
      background: var(--accent);
      color: #ffffff;
      border-color: var(--accent);
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .table-wrapper table {
      min-width: 720px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.84rem;
    }

    thead tr {
      background: #f9fafb;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eef0f4;
    }

    th {
      text-align: left;
      color: var(--text-muted);
      font-weight: 500;
      font-size: 0.78rem;
    }

    .tbl-name {
      font-weight: 500;
    }

    .tbl-num {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr:hover {
      background: #f4f5fb;
    }

    .row-total td {
      font-weight: 600;
      background: #eef2ff;
    }

    .row-prom td {
      font-weight: 600;
      background: #e0f2fe;
    }

    .val-csat.pos, .val-uplift.pos {
      color: var(--accent-good);
    }

    .val-csat.neg, .val-uplift.neg {
      color: var(--accent-bad);
    }

    .val-csat.neutral, .val-uplift.neutral {
      color: var(--accent);
    }

    .ranking-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(0, 1fr));
      gap: 16px;
      margin-top: 18px;
    }

    .ranking-card {
      background: #f9fafb;
      border-radius: 14px;
      padding: 12px 14px 14px;
      border: 1px solid #e5e7eb;
    }

    .ranking-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .ranking-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .section-title {
      margin-top: 24px;
      margin-bottom: 4px;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .level-tag {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .plus-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 4px;
      background: #e5f0ff;
      color: var(--accent);
      font-size: 0.75rem;
      font-weight: 700;
      border: 1px solid #bfdbfe;
      margin-left: 6px;
      cursor: pointer;
    }

    .center-cell {
      padding-left: 24px;
    }

    .center-cell-empty {
      padding-left: 24px;
    }

    .note-inline {
      margin-top: 6px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    th.sortable-col {
      cursor: pointer;
      user-select: none;
    }

    .sort-label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      justify-content: flex-end;
      width: 100%;
    }

    .sort-indicator {
      font-size: 0.65rem;
      opacity: 0.5;
    }

    /* Scroll interno evoluciones */
    .table-wrapper-ranking {
      max-height: 190px;
      overflow-y: auto;
      overflow-x: auto;
      position: relative;
      width: 100%;
      -webkit-overflow-scrolling: touch;
    }

    .table-wrapper-ranking table {
      min-width: 520px;
    }

    .table-wrapper-ranking thead th {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
    }

    /* Primera columna fija (Driver) */
    .ranking-table th:first-child,
    .ranking-table td:first-child {
      position: sticky;
      left: 0;
      z-index: 2;
      background: #f9fafb;
    }

    .ranking-table tbody td:first-child {
      background: #ffffff;
    }

    .ranking-table thead th:first-child {
      z-index: 3;
    }

    .ranking-table th:nth-child(n+2),
    .ranking-table td:nth-child(n+2) {
      width: 70px;
      white-space: nowrap;
    }

    /* Drivers en servicios agregados */
    .drivers-cell {
      font-size: 0.78rem;
      color: var(--text-muted);
      white-space: normal;
    }

    .driver-row .drivers-cell {
      font-style: italic;
    }

    @media (max-width: 768px) {
      .page {
        padding: 16px 10px 28px;
      }

      .title-main {
        font-size: 1.5rem;
      }

      .summary-card {
        padding: 10px 12px;
      }

      .card {
        padding: 12px 12px 14px;
      }

      .table-wrapper table {
        min-width: 600px;
      }

      .table-wrapper-ranking table {
        min-width: 520px;
      }

      table {
        font-size: 0.8rem;
      }

      th, td {
        padding: 5px 6px;
      }

      .ranking-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <!-- ENCABEZADO -->
    <header>
      <div class="title-row">
        <div>
          <div class="title-main"><span>CXDIP</span> Customers Say</div>
          <div class="title-sub">
            Procesamiento de texto abierto.
          </div>
        </div>
        <div class="badge-secondary">
          Demo · Valores de ejemplo (reemplazar con ETL)
        </div>
      </div>

      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">Total de respuestas</div>
          <div class="summary-value" id="summary-total">–</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Respuestas con comentario</div>
          <div class="summary-value" id="summary-with-text">–</div>
          <div class="summary-foot" id="summary-text-pct">–</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">IBB global (texto)</div>
          <div class="summary-value" id="summary-ibb">–</div>
          <div class="summary-foot">
            (% promotores – % detractores) · sólo casos con comentario
          </div>
        </div>
      </div>
      
    </header>

    <!-- DRIVERS MACRO -->
    <section class="card">
      <h2>Drivers Macro</h2>
      <div class="card-subtitle">
        Tabla consolidada por atributo
      </div>

      <!-- Selector de año -->
      <div class="filter-row">
        <span class="filter-label">Selecciona el Año que quieres analizar:</span>
        <select id="year-select" class="year-select">
          <option value="2023">2023</option>
          <option value="2024" selected>2024</option>
          <option value="2025">2025</option>
        </select>
        <span class="filter-hint"></span>
      </div>

      <div class="table-wrapper">
        <table id="drivers-table">
          <thead>
            <tr>
              <th>Atributos macro</th>
              <th class="sortable-col" data-sort-type="int" style="text-align:right;">
                <span class="sort-label">
                  N° comentarios
                  <span class="sort-indicator">↕</span>
                </span>
              </th>
              <th class="sortable-col" data-sort-type="percent" style="text-align:right;">
                <span class="sort-label">
                  % sobre texto
                  <span class="sort-indicator">↕</span>
                </span>
              </th>
              <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                <span class="sort-label">
                  CSAT atributo
                  <span class="sort-indicator">↕</span>
                </span>
              </th>
              <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                <span class="sort-label">
                  Uplift atributo
                  <span class="sort-indicator">↕</span>
                </span>
              </th>
            </tr>
          </thead>
          <tbody>
            <!-- Rellenado por JS -->
          </tbody>
        </table>
      </div>

      <!-- EVOLUCIÓN CSAT / UPLIFT -->
      <div class="ranking-row">
        <!-- Evolución CSAT -->
        <div class="ranking-card">
          <div class="ranking-title">Evolución CSAT atributo</div>
          <div class="ranking-sub">
            Evolución del CSAT por atributo.
          </div>

          <div class="table-wrapper table-wrapper-ranking">
            <table class="ranking-table ranking-csat">
              <thead>
                <tr>
                  <th>Driver</th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">T1<span class="sort-indicator">↕</span></span>
                  </th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">T2<span class="sort-indicator">↕</span></span>
                  </th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">T3<span class="sort-indicator">↕</span></span>
                  </th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">T4<span class="sort-indicator">↕</span></span>
                  </th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">Total anual<span class="sort-indicator">↕</span></span>
                  </th>
                </tr>
              </thead>
              <tbody>
                <!-- JS -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Evolución Uplift -->
        <div class="ranking-card">
          <div class="ranking-title">Evolución Uplift atributo</div>

          <div class="table-wrapper table-wrapper-ranking">
            <table class="ranking-table ranking-uplift">
              <thead>
                <tr>
                  <th>Driver</th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">T1<span class="sort-indicator">↕</span></span>
                  </th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">T2<span class="sort-indicator">↕</span></span>
                  </th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">T3<span class="sort-indicator">↕</span></span>
                  </th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">T4<span class="sort-indicator">↕</span></span>
                  </th>
                  <th class="sortable-col" data-sort-type="decimal" style="text-align:right;">
                    <span class="sort-label">Total anual<span class="sort-indicator">↕</span></span>
                  </th>
                </tr>
              </thead>
              <tbody>
                <!-- JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- SERVICIOS AGREGADOS -->
    <div class="section-title">SERVICIOS AGREGADOS</div>

    <section class="card">
      <div class="level-tag">Vista por servicio (apertura con “+”).</div>

      <!-- Filtro de trimestres -->
      <div class="filter-row">
        <span class="filter-label">Trimestres:</span>
        <div class="trim-pills" id="trim-filter">
          <div class="trim-pill selected" data-trim="1">T1</div>
          <div class="trim-pill selected" data-trim="2">T2</div>
          <div class="trim-pill selected" data-trim="3">T3</div>
          <div class="trim-pill selected" data-trim="4">T4</div>
        </div>
        <span class="filter-hint">Selecciona uno o varios trimestres. Los datos respetan el año elegido arriba.</span>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Servicio / Centro</th>
              <th>Atributos mencionados</th>
              <th style="text-align:right;">N° comentarios</th>
              <th style="text-align:right;">% sobre texto</th>
              <th style="text-align:right;">NPS</th>
              <th style="text-align:right;">CSAT atributo</th>
              <th style="text-align:right;">Uplift atributo</th>
            </tr>
          </thead>
          <tbody id="services-tbody">
            <!-- JS -->
          </tbody>
        </table>
      </div>

      <div class="note-inline">
        Al presionar <span class="plus-btn" style="pointer-events:none;">+</span> se despliegan los centros asociados
        a cada servicio con sus métricas (NPS, comentarios, % sobre texto, CSAT, Uplift) y los drivers desagregados por fila.
      </div>
    </section>
  </div>
  <script>
    // --------- UTILIDADES ---------
    function parseCellValue(text, type) {
      if (!text) return null;
      text = String(text).trim();
      if (text === "–" || text === "-" || text === "") return null;
      text = text.replace(/\s/g, "");
  
      if (type === "int") {
        var cleanedInt = text.replace(/\./g, "");
        var intVal = parseInt(cleanedInt, 10);
        return isNaN(intVal) ? null : intVal;
      }
  
      if (type === "percent") {
        var cleanedPct = text.replace("%", "").replace(/\./g, "").replace(",", ".");
        var pctVal = parseFloat(cleanedPct);
        return isNaN(pctVal) ? null : pctVal;
      }
  
      if (type === "decimal") {
        var cleanedDec = text.replace("+", "").replace("–", "-").replace(",", ".");
        var decVal = parseFloat(cleanedDec);
        return isNaN(decVal) ? null : decVal;
      }
      return null;
    }
  
    function formatDecimal(value, decimals, withSign) {
      if (value === null || typeof value === "undefined" || isNaN(value)) return "–";
      var fixed = value.toFixed(decimals);
      var out = fixed.replace(".", ",");
      if (withSign && value > 0) out = "+" + out;
      return out;
    }
  
    function formatInt(value) {
      if (value === null || typeof value === "undefined" || isNaN(value)) return "–";
      return new Intl.NumberFormat("es-CL").format(value);
    }
  
    // Para colorear IBB
    function getIbbClass(v) {
      if (v === null || isNaN(v)) return "neutral";
      if (v >= 50) return "pos";      // muy bueno
      if (v <= 0) return "neg";       // preocupante
      return "neutral";               // zona media
    }
  
    function getUpliftClass(v) {
      if (v === null || isNaN(v)) return "neutral";
      if (v > 0.01) return "pos";
      if (v < -0.01) return "neg";
      return "neutral";
    }
  
    // --------- ORDEN TABLA DRIVERS MACRO ---------
    (function () {
      var table = document.getElementById("drivers-table");
      if (!table) return;
  
      table.querySelectorAll("thead th.sortable-col").forEach(function (th) {
        th.dataset.sortDirection = "none";
  
        th.addEventListener("click", function () {
          var sortType = th.dataset.sortType || "decimal";
          var colIndex = Array.prototype.indexOf.call(th.parentNode.children, th);
          var current = th.dataset.sortDirection;
          var next = current === "asc" ? "desc" : "asc";
          th.dataset.sortDirection = next;
          var direction = next === "asc" ? 1 : -1;
  
          table.querySelectorAll("thead th.sortable-col").forEach(function (other) {
            if (other !== th) {
              other.dataset.sortDirection = "none";
              var io = other.querySelector(".sort-indicator");
              if (io) io.textContent = "↕";
            }
          });
  
          var icon = th.querySelector(".sort-indicator");
          if (icon) icon.textContent = next === "asc" ? "▲" : "▼";
  
          var tbody = table.querySelector("tbody");
          var totalRow = tbody.querySelector(".row-total");
          var promRow = tbody.querySelector(".row-prom");
  
          var dataRows = Array.from(tbody.querySelectorAll("tr")).filter(function (row) {
            return !row.classList.contains("row-total") && !row.classList.contains("row-prom");
          });
  
          dataRows.sort(function (rowA, rowB) {
            var textA = rowA.children[colIndex].textContent;
            var textB = rowB.children[colIndex].textContent;
            var valA = parseCellValue(textA, sortType);
            var valB = parseCellValue(textB, sortType);
  
            if (valA === null && valB === null) return 0;
            if (valA === null) return 1;
            if (valB === null) return -1;
            return (valA - valB) * direction;
          });
  
          tbody.innerHTML = "";
          dataRows.forEach(function (r) { tbody.appendChild(r); });
          if (totalRow) tbody.appendChild(totalRow);
          if (promRow) tbody.appendChild(promRow);
        });
      });
    })();
  
    // --------- ORDEN TABLAS RANKING (CSAT / UPLIFT) ---------
    (function () {
      var rankingTables = document.querySelectorAll(".ranking-table");
      rankingTables.forEach(function (table) {
        var tbody = table.querySelector("tbody");
  
        table.querySelectorAll("thead th.sortable-col").forEach(function (th) {
          th.dataset.sortDirection = "none";
  
          th.addEventListener("click", function () {
            var sortType = th.dataset.sortType || "decimal";
            var colIndex = Array.prototype.indexOf.call(th.parentNode.children, th);
            var current = th.dataset.sortDirection;
            var next = current === "asc" ? "desc" : "asc";
            th.dataset.sortDirection = next;
            var direction = next === "asc" ? 1 : -1;
  
            table.querySelectorAll("thead th.sortable-col").forEach(function (other) {
              if (other !== th) {
                other.dataset.sortDirection = "none";
                var io = other.querySelector(".sort-indicator");
                if (io) io.textContent = "↕";
              }
            });
  
            var icon = th.querySelector(".sort-indicator");
            if (icon) icon.textContent = next === "asc" ? "▲" : "▼";
  
            var dataRows = Array.from(tbody.querySelectorAll("tr"));
  
            dataRows.sort(function (rowA, rowB) {
              var textA = rowA.children[colIndex].textContent;
              var textB = rowB.children[colIndex].textContent;
              var valA = parseCellValue(textA, sortType);
              var valB = parseCellValue(textB, sortType);
  
              if (valA === null && valB === null) return 0;
              if (valA === null) return 1;
              if (valB === null) return -1;
              return (valA - valB) * direction;
            });
  
            tbody.innerHTML = "";
            dataRows.forEach(function (r) { tbody.appendChild(r); });
          });
        });
      });
    })();
  
    // ==========================================================
    // DATOS DEL JSON
    // ==========================================================
  
    const PANEL_JSON_URL = "C:/Users/Ariel/OneDrive/Documentos/GitHub/cxdip.com/01_Customers_say/01_00_redsalud/00_redsalud_Customers_say.json";
  
    let panelData = null;
    let selectedYear = null;
    let selectedTrims = [1, 2, 3, 4];
  
    // --------- RESUMEN CABECERA ---------
    function updateSummaryCards() {
      if (!panelData || !selectedYear) return;
      const summaryYear = panelData.summary[selectedYear];
      if (!summaryYear) return;
  
      const total = summaryYear.total_respuestas || 0;
      const withText = summaryYear.total_comentario || 0;
      const ibb = summaryYear.ibb;
  
      const totalEl = document.getElementById("summary-total");
      const withTextEl = document.getElementById("summary-with-text");
      const pctEl = document.getElementById("summary-text-pct");
      const ibbEl = document.getElementById("summary-ibb");
  
      if (totalEl) totalEl.textContent = formatInt(total);
      if (withTextEl) withTextEl.textContent = formatInt(withText);
  
      if (pctEl) {
        const pct = total ? (withText / total) * 100 : 0;
        pctEl.textContent = total ? formatDecimal(pct, 1, false) + "% aportan texto" : "";
      }
  
      if (ibbEl) {
        ibbEl.textContent = ibb === null || typeof ibb === "undefined"
          ? "–"
          : formatDecimal(ibb, 1, false);
      }
    }
  
    // --------- DRIVERS MACRO ---------
    function renderDriversMacro(year) {
      const tbody = document.querySelector("#drivers-table tbody");
      if (!tbody || !panelData) return;
  
      const yearStr = String(year);
      const rowsData = panelData.drivers_macro[yearStr] || [];
      const summaryYear = panelData.summary[yearStr];
      if (!summaryYear) return;
  
      const totalText = summaryYear.total_comentario || 0;
      const globalIbb = summaryYear.ibb;
  
      tbody.innerHTML = "";
  
      let totalComments = 0;
  
      rowsData.forEach(function (row) {
        const tr = document.createElement("tr");
        const total = row.total || {};
        const comments = total.comments || 0;
        totalComments += comments;
  
        const pctVal = totalText ? (comments / totalText) * 100 : 0;
        const ibbVal = total.ibb;
        const upliftVal = total.uplift;
  
        const tdDriver = document.createElement("td");
        tdDriver.className = "tbl-name";
        tdDriver.textContent = row.driver;
        tr.appendChild(tdDriver);
  
        const tdComments = document.createElement("td");
        tdComments.className = "tbl-num";
        tdComments.textContent = formatInt(comments);
        tr.appendChild(tdComments);
  
        const tdPct = document.createElement("td");
        tdPct.className = "tbl-num";
        tdPct.textContent = totalText
          ? formatDecimal(pctVal, 1, false) + "%"
          : "0,0%";
        tr.appendChild(tdPct);
  
        const tdIbb = document.createElement("td");
        tdIbb.className = "tbl-num val-csat " + getIbbClass(ibbVal);
        tdIbb.textContent =
          ibbVal === null || typeof ibbVal === "undefined"
            ? "–"
            : formatDecimal(ibbVal, 1, false);
        tr.appendChild(tdIbb);
  
        const tdUplift = document.createElement("td");
        tdUplift.className = "tbl-num val-uplift " + getUpliftClass(upliftVal);
        tdUplift.textContent =
          upliftVal === null || typeof upliftVal === "undefined"
            ? "–"
            : formatDecimal(upliftVal, 1, true);
        tr.appendChild(tdUplift);
  
        tbody.appendChild(tr);
      });
  
      // Fila Totales
      const trTotal = document.createElement("tr");
      trTotal.className = "row-total";
  
      const tdLabelTot = document.createElement("td");
      tdLabelTot.className = "tbl-name";
      tdLabelTot.textContent = "Totales";
      trTotal.appendChild(tdLabelTot);
  
      const tdCommTot = document.createElement("td");
      tdCommTot.className = "tbl-num";
      tdCommTot.textContent = formatInt(totalComments);
      trTotal.appendChild(tdCommTot);
  
      const tdPctTot = document.createElement("td");
      tdPctTot.className = "tbl-num";
      tdPctTot.textContent = totalText ? "100,0%" : "0,0%";
      trTotal.appendChild(tdPctTot);
  
      const tdIbbTot = document.createElement("td");
      tdIbbTot.className = "tbl-num";
      tdIbbTot.textContent = "–";
      trTotal.appendChild(tdIbbTot);
  
      const tdUpliftTot = document.createElement("td");
      tdUpliftTot.className = "tbl-num";
      tdUpliftTot.textContent = "–";
      trTotal.appendChild(tdUpliftTot);
  
      tbody.appendChild(trTotal);
  
      // Fila Promedios (IBB global y uplift 0)
      const trProm = document.createElement("tr");
      trProm.className = "row-prom";
  
      const tdLabelProm = document.createElement("td");
      tdLabelProm.className = "tbl-name";
      tdLabelProm.textContent = "Promedios";
      trProm.appendChild(tdLabelProm);
  
      const tdVoid1 = document.createElement("td");
      tdVoid1.className = "tbl-num";
      tdVoid1.textContent = "–";
      trProm.appendChild(tdVoid1);
  
      const tdVoid2 = document.createElement("td");
      tdVoid2.className = "tbl-num";
      tdVoid2.textContent = "–";
      trProm.appendChild(tdVoid2);
  
      const tdIbbProm = document.createElement("td");
      tdIbbProm.className = "tbl-num val-csat " + getIbbClass(globalIbb);
      tdIbbProm.textContent = formatDecimal(globalIbb, 1, false);
      trProm.appendChild(tdIbbProm);
  
      const tdUpliftProm = document.createElement("td");
      tdUpliftProm.className = "tbl-num val-uplift " + getUpliftClass(0);
      tdUpliftProm.textContent = formatDecimal(0, 1, true);
      trProm.appendChild(tdUpliftProm);
  
      tbody.appendChild(trProm);
    }
  
    // --------- EVOLUCIÓN IBB / UPLIFT POR DRIVER ---------
    function renderEvolutionTables(year) {
      if (!panelData) return;
      const yearStr = String(year);
      const rowsData = panelData.drivers_macro[yearStr] || [];
  
      const csatBody = document.querySelector(".ranking-csat tbody");
      const upliftBody = document.querySelector(".ranking-uplift tbody");
      if (!csatBody || !upliftBody) return;
  
      csatBody.innerHTML = "";
      upliftBody.innerHTML = "";
  
      rowsData.forEach(function (row) {
        const trCsat = document.createElement("tr");
        const trUplift = document.createElement("tr");
  
        const tdDriver1 = document.createElement("td");
        tdDriver1.className = "tbl-name";
        tdDriver1.textContent = row.driver;
        trCsat.appendChild(tdDriver1);
  
        const tdDriver2 = document.createElement("td");
        tdDriver2.className = "tbl-name";
        tdDriver2.textContent = row.driver;
        trUplift.appendChild(tdDriver2);
  
        let sumIbb = 0;
        let countIbb = 0;
        let sumUplift = 0;
        let countUplift = 0;
  
        for (let t = 1; t <= 4; t++) {
          const tData = row.trimesters[t] || row.trimesters[String(t)] || null;
          const ibbVal = tData ? tData.ibb : null;
          const uplVal = tData ? tData.uplift : null;
  
          // CSAT/IBB
          const tdIbb = document.createElement("td");
          tdIbb.className = "tbl-num val-csat " + getIbbClass(ibbVal);
          tdIbb.textContent =
            ibbVal === null || typeof ibbVal === "undefined"
              ? "–"
              : formatDecimal(ibbVal, 1, false);
          trCsat.appendChild(tdIbb);
  
          // Uplift
          const tdUp = document.createElement("td");
          tdUp.className = "tbl-num val-uplift " + getUpliftClass(uplVal);
          tdUp.textContent =
            uplVal === null || typeof uplVal === "undefined"
              ? "–"
              : formatDecimal(uplVal, 1, true);
          trUplift.appendChild(tdUp);
  
          if (ibbVal !== null && typeof ibbVal !== "undefined" && !isNaN(ibbVal)) {
            sumIbb += ibbVal;
            countIbb++;
          }
          if (uplVal !== null && typeof uplVal !== "undefined" && !isNaN(uplVal)) {
            sumUplift += uplVal;
            countUplift++;
          }
        }
  
        const avgIbb = countIbb ? sumIbb / countIbb : null;
        const avgUplift = countUplift ? sumUplift / countUplift : null;
  
        const tdTotalIbb = document.createElement("td");
        tdTotalIbb.className = "tbl-num val-csat " + getIbbClass(avgIbb);
        tdTotalIbb.textContent =
          avgIbb === null ? "–" : formatDecimal(avgIbb, 1, false);
        trCsat.appendChild(tdTotalIbb);
  
        const tdTotalUp = document.createElement("td");
        tdTotalUp.className = "tbl-num val-uplift " + getUpliftClass(avgUplift);
        tdTotalUp.textContent =
          avgUplift === null ? "–" : formatDecimal(avgUplift, 1, true);
        trUplift.appendChild(tdTotalUp);
  
        csatBody.appendChild(trCsat);
        upliftBody.appendChild(trUplift);
      });
    }
  
    // --------- SERVICIOS AGREGADOS ---------
  
    function aggregateServiceEntry(entry, trims) {
      if (!entry) return null;
      if (!trims || !trims.length) trims = [1, 2, 3, 4];
  
      const triData = entry.trimesters || {};
      let comments = 0, prom = 0, det = 0, neu = 0;
  
      trims.forEach(function (t) {
        const q = triData[t] || triData[String(t)];
        if (!q) return;
        comments += q.comments || 0;
        prom += q.promotores || 0;
        det += q.detractores || 0;
        neu += q.neutros || 0;
      });
  
      if (!comments) return null;
  
      const ibbVal = 100 * ((prom / comments) - (det / comments));
      return {
        comments: comments,
        promotores: prom,
        detractores: det,
        neutros: neu,
        ibb: ibbVal,
        nps: ibbVal
      };
    }
  
    function initServiceToggles() {
      document.querySelectorAll(".service-toggle").forEach(function (btn) {
        btn.onclick = function () {
          const sid = this.getAttribute("data-service");
          const expanded = this.getAttribute("data-expanded") === "true";
          const rows = document.querySelectorAll("tr[data-parent='" + sid + "']");
          rows.forEach(function (row) {
            row.style.display = expanded ? "none" : "table-row";
          });
          this.textContent = expanded ? "+" : "–";
          this.setAttribute("data-expanded", expanded ? "false" : "true");
        };
      });
    }
  
    function renderServicesTable(year, trims) {
      const tbody = document.getElementById("services-tbody");
      if (!tbody || !panelData) return;
  
      const yearStr = String(year);
      const servicesYear = panelData.services[yearStr] || [];
      const summaryYear = panelData.summary[yearStr];
      if (!summaryYear) return;
      const yearTextTotal = summaryYear.total_comentario || 0;
      const globalIbb = summaryYear.ibb;
  
      // Reorganizar por servicio
      const byService = {};
      servicesYear.forEach(function (e) {
        const key = e.servicio || "Sin servicio";
        if (!byService[key]) byService[key] = { service: null, centers: [] };
        if (e.centro === null) {
          byService[key].service = e;
        } else {
          byService[key].centers.push(e);
        }
      });
  
      tbody.innerHTML = "";
      let serviceIndex = 0;
  
      Object.keys(byService).sort().forEach(function (servName) {
        const group = byService[servName];
        const serviceEntry = group.service;
        const centers = group.centers || [];
        const serviceId = "serv" + (++serviceIndex);
  
        if (serviceEntry) {
          const aggService = aggregateServiceEntry(serviceEntry, trims) || serviceEntry.total;
          if (aggService && aggService.comments > 0) {
            const trServ = document.createElement("tr");
  
            const tdName = document.createElement("td");
            tdName.className = "tbl-name";
            tdName.innerHTML =
              (serviceEntry.servicio || "Servicio") +
              ' <button class="plus-btn service-toggle" data-service="' + serviceId + '" data-expanded="false">+</button>';
            trServ.appendChild(tdName);
  
            const tdDrivers = document.createElement("td");
            tdDrivers.className = "drivers-cell";
            tdDrivers.textContent = (serviceEntry.drivers || []).join(", ") || "–";
            trServ.appendChild(tdDrivers);
  
            const tdComments = document.createElement("td");
            tdComments.className = "tbl-num";
            tdComments.textContent = formatInt(aggService.comments);
            trServ.appendChild(tdComments);
  
            const tdPct = document.createElement("td");
            tdPct.className = "tbl-num";
            const pctService = yearTextTotal
              ? (aggService.comments / yearTextTotal) * 100
              : 0;
            tdPct.textContent = yearTextTotal
              ? formatDecimal(pctService, 1, false) + "%"
              : "0,0%";
            trServ.appendChild(tdPct);
  
            const tdNps = document.createElement("td");
            tdNps.className = "tbl-num";
            tdNps.textContent = formatDecimal(aggService.nps, 1, false);
            trServ.appendChild(tdNps);
  
            const tdIbb = document.createElement("td");
            tdIbb.className = "tbl-num val-csat " + getIbbClass(aggService.ibb);
            tdIbb.textContent = formatDecimal(aggService.ibb, 1, false);
            trServ.appendChild(tdIbb);
  
            const uplift = aggService.ibb - globalIbb;
            const tdUplift = document.createElement("td");
            tdUplift.className = "tbl-num val-uplift " + getUpliftClass(uplift);
            tdUplift.textContent = formatDecimal(uplift, 1, true);
            trServ.appendChild(tdUplift);
  
            tbody.appendChild(trServ);
  
            // Centros
            centers.forEach(function (centerEntry) {
              const aggCenter = aggregateServiceEntry(centerEntry, trims) || centerEntry.total;
              if (!aggCenter || !aggCenter.comments) return;
  
              const trCenter = document.createElement("tr");
              trCenter.className = "center-row";
              trCenter.setAttribute("data-parent", serviceId);
              trCenter.style.display = "none";
  
              const tdSC = document.createElement("td");
              tdSC.className = "tbl-name center-cell";
              tdSC.textContent = "↳ " + (centerEntry.centro || "Centro");
              trCenter.appendChild(tdSC);
  
              const tdDrv = document.createElement("td");
              tdDrv.className = "drivers-cell";
              tdDrv.textContent = (centerEntry.drivers || [])[0] || "–";
              trCenter.appendChild(tdDrv);
  
              const tdCommC = document.createElement("td");
              tdCommC.className = "tbl-num";
              tdCommC.textContent = formatInt(aggCenter.comments);
              trCenter.appendChild(tdCommC);
  
              const tdPctC = document.createElement("td");
              tdPctC.className = "tbl-num";
              const pctC = yearTextTotal
                ? (aggCenter.comments / yearTextTotal) * 100
                : 0;
              tdPctC.textContent = yearTextTotal
                ? formatDecimal(pctC, 1, false) + "%"
                : "0,0%";
              trCenter.appendChild(tdPctC);
  
              const tdNpsC = document.createElement("td");
              tdNpsC.className = "tbl-num";
              tdNpsC.textContent = formatDecimal(aggCenter.nps, 1, false);
              trCenter.appendChild(tdNpsC);
  
              const tdIbbC = document.createElement("td");
              tdIbbC.className = "tbl-num val-csat " + getIbbClass(aggCenter.ibb);
              tdIbbC.textContent = formatDecimal(aggCenter.ibb, 1, false);
              trCenter.appendChild(tdIbbC);
  
              const upliftC = aggCenter.ibb - globalIbb;
              const tdUpliftC = document.createElement("td");
              tdUpliftC.className = "tbl-num val-uplift " + getUpliftClass(upliftC);
              tdUpliftC.textContent = formatDecimal(upliftC, 1, true);
              trCenter.appendChild(tdUpliftC);
  
              tbody.appendChild(trCenter);
  
              // Drivers adicionales (solo texto)
              const driversExtra = (centerEntry.drivers || []).slice(1);
              driversExtra.forEach(function (drvName) {
                const trDrv = document.createElement("tr");
                trDrv.className = "center-row driver-row";
                trDrv.setAttribute("data-parent", serviceId);
                trDrv.style.display = "none";
  
                const tdEmpty = document.createElement("td");
                tdEmpty.className = "tbl-name center-cell-empty";
                tdEmpty.textContent = "";
                trDrv.appendChild(tdEmpty);
  
                const tdDrvName = document.createElement("td");
                tdDrvName.className = "drivers-cell";
                tdDrvName.textContent = drvName;
                trDrv.appendChild(tdDrvName);
  
                for (var k = 0; k < 5; k++) {
                  var tdm = document.createElement("td");
                  tdm.className = "tbl-num";
                  tdm.textContent = "–";
                  trDrv.appendChild(tdm);
                }
  
                tbody.appendChild(trDrv);
              });
            });
          }
        }
      });
  
      initServiceToggles();
    }
  
    // --------- REFRESH + FILTROS ---------
    function refreshAll() {
      if (!panelData || !selectedYear) return;
      updateSummaryCards();
      renderDriversMacro(selectedYear);
      renderEvolutionTables(selectedYear);
      renderServicesTable(selectedYear, selectedTrims);
    }
  
    function initFilters() {
      const yearSelect = document.getElementById("year-select");
      if (yearSelect && panelData) {
        yearSelect.innerHTML = "";
        (panelData.years || []).forEach(function (y) {
          const opt = document.createElement("option");
          opt.value = String(y);
          opt.textContent = String(y);
          if (String(y) === String(selectedYear)) opt.selected = true;
          yearSelect.appendChild(opt);
        });
  
        yearSelect.addEventListener("change", function () {
          selectedYear = this.value;
          refreshAll();
        });
      }
  
      document.querySelectorAll("#trim-filter .trim-pill").forEach(function (pill) {
        pill.addEventListener("click", function () {
          const t = parseInt(this.getAttribute("data-trim"), 10);
          const idx = selectedTrims.indexOf(t);
  
          if (idx !== -1) {
            if (selectedTrims.length === 1) return; // siempre al menos uno
            selectedTrims.splice(idx, 1);
            this.classList.remove("selected");
          } else {
            selectedTrims.push(t);
            selectedTrims.sort();
            this.classList.add("selected");
          }
          refreshAll();
        });
      });
    }
  
    // --------- CARGA DEL JSON ---------
    fetch(PANEL_JSON_URL)
      .then(function (resp) { return resp.json(); })
      .then(function (data) {
        panelData = data;
        if (data.years && data.years.length) {
          selectedYear = String(data.years[0]);
        } else {
          selectedYear = Object.keys(data.summary || {})[0];
        }
        initFilters();
        refreshAll();
      })
      .catch(function (err) {
        console.error("Error cargando JSON Customers Say:", err);
      });
  </script>
  </body>
</html>
