<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CXDIP · Customers Say - RedSalud IBB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    /* --- ESTILOS CSS (Sin cambios estructurales) --- */
    :root {
      --bg: #f5f7fb; --card: #ffffff; --border: #e2e8f0;
      --text-main: #0f172a; --text-muted: #64748b;
      --accent: #2563eb; --accent-soft: #38bdf8;
      --accent-good: #16a34a; --accent-bad: #ef4444;
      --radius-card: 16px; --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.06);
    }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; padding: 0; background: var(--bg); color: var(--text-main); }
    .page { max-width: 1320px; margin: 0 auto; padding: 24px 18px 40px; }
    
    /* Header & Summary */
    .title-row { display: flex; align-items: baseline; justify-content: space-between; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
    .title-main { font-size: 1.9rem; font-weight: 700; letter-spacing: -0.02em; }
    .title-main span { color: var(--accent); }
    .title-sub { font-size: 0.9rem; color: var(--text-muted); margin-top: 4px; }
    .badge-secondary { padding: 6px 10px; border-radius: 999px; background: #e0f2fe; color: #0369a1; font-size: 0.75rem; font-weight: 500; }
    
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; margin-top: 18px; }
    .summary-card { background: var(--card); border-radius: var(--radius-card); padding: 14px 16px; border: 1px solid var(--border); box-shadow: var(--shadow-soft); }
    .summary-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; }
    .summary-value { font-size: 1.35rem; font-weight: 600; }
    .summary-foot { font-size: 0.78rem; color: var(--text-muted); margin-top: 4px; }

    /* Cards & Tables */
    .card { background: var(--card); border-radius: var(--radius-card); padding: 16px 18px 18px; border: 1px solid var(--border); box-shadow: var(--shadow-soft); margin-top: 18px; }
    .card h2 { margin: 0 0 8px; font-size: 1.05rem; font-weight: 600; }
    .card-subtitle { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; }

    .filter-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin: 6px 0 10px; }
    .filter-label, .filter-hint { font-size: 0.78rem; color: var(--text-muted); }
    
    .year-select { padding: 4px 16px; border-radius: 999px; border: 1px solid var(--accent); background: var(--accent); font-size: 0.8rem; color: #ffffff; font-weight: 600; cursor: pointer; }
    .trim-pills { display: inline-flex; flex-wrap: wrap; gap: 6px; }
    .trim-pill { border-radius: 999px; border: 1px solid #c7d2fe; background: #e5edff; padding: 3px 10px; font-size: 0.78rem; color: var(--text-muted); cursor: pointer; user-select: none; transition: all 0.2s; }
    .trim-pill:hover { background: #dbeafe; }
    .trim-pill.selected { background: var(--accent); color: #ffffff; border-color: var(--accent); }

    .table-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; font-size: 0.84rem; min-width: 720px; }
    thead tr { background: #f9fafb; }
    th, td { padding: 6px 8px; border-bottom: 1px solid #eef0f4; }
    th { text-align: left; color: var(--text-muted); font-weight: 500; font-size: 0.78rem; }
    .tbl-name { font-weight: 500; }
    .tbl-num { text-align: right; font-variant-numeric: tabular-nums; }
    tbody tr:hover { background: #f8fafc; }
    
    .val-csat.pos, .val-uplift.pos { color: var(--accent-good); }
    .val-csat.neg, .val-uplift.neg { color: var(--accent-bad); }
    .val-csat.neutral, .val-uplift.neutral { color: var(--accent); }

    .row-total td { font-weight: 600; background: #eef2ff; }
    .row-prom td { font-weight: 600; background: #e0f2fe; }

    /* Ranking Tables */
    .ranking-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(0, 1fr)); gap: 16px; margin-top: 18px; }
    .ranking-card { background: #f9fafb; border-radius: 14px; padding: 12px 14px 14px; border: 1px solid #e5e7eb; }
    .ranking-title { font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; }
    .table-wrapper-ranking { max-height: 190px; overflow-y: auto; }
    .table-wrapper-ranking thead th { position: sticky; top: 0; background: #f9fafb; z-index: 1; }

    /* Servicios Agregados - Jerarquía */
    .section-title { margin-top: 24px; margin-bottom: 4px; font-size: 0.9rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.06em; }
    .level-tag { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; }
    
    .plus-btn { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; border-radius: 4px; background: #eff6ff; color: var(--accent); font-size: 0.75rem; font-weight: 700; border: 1px solid #bfdbfe; margin-left: 6px; cursor: pointer; }
    .plus-btn:hover { background: #dbeafe; }

    .service-row td { background: #f1f5f9; border-bottom: 2px solid #cbd5e1; font-weight: 600; }
    .center-row .tbl-name { padding-left: 24px; font-weight: 500; color: #334155; }
    .driver-row .tbl-name { padding-left: 48px; font-weight: 400; font-style: italic; color: #64748b; font-size: 0.8rem; }
    
    .note-inline { margin-top: 6px; font-size: 0.78rem; color: var(--text-muted); }

    /* Sorting */
    th.sortable-col { cursor: pointer; user-select: none; transition: background 0.1s; }
    th.sortable-col:hover { background: #f1f5f9; }
    .sort-label { display: inline-flex; align-items: center; gap: 4px; justify-content: flex-end; width: 100%; }
    .sort-indicator { font-size: 0.65rem; opacity: 0.5; }

    @media (max-width: 768px) {
      .page { padding: 16px 10px 28px; }
      .ranking-row { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <div class="title-row">
        <div>
          <div class="title-main"><span>CXDIP</span> Customers Say</div>
          <div class="title-sub">Procesamiento de texto abierto y medición de IBB.</div>
        </div>
        <div class="badge-secondary">Data cargada desde ETL Python</div>
      </div>

      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">Total Comentarios (Selección)</div>
          <div class="summary-value" id="total-comments">--</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Nº Atributos Macro</div>
          <div class="summary-value" id="total-attributes">--</div>
          <div class="summary-foot">Incluye "Otro/Inclasificable"</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">IBB Global (Selección)</div>
          <div class="summary-value" id="overall-ibb">--</div>
          <div class="summary-foot">Índice de Balance de Bajas</div>
        </div>
      </div>
    </header>

    <section class="card">
      <h2>Drivers Macro</h2>
      <div class="card-subtitle">Tabla consolidada por atributo (Global Anual)</div>
      
      <div class="filter-row">
        <span class="filter-label">Año:</span>
        <select id="year-select" class="year-select"><option value="2025" selected>2025</option></select>
        <span class="filter-hint">Data más reciente disponible.</span>
      </div>

      <div class="table-wrapper">
        <table id="drivers-table">
          <thead>
            <tr>
              <th>Atributos macro</th>
              <th class="sortable-col" data-sort-type="int"><span class="sort-label">N° comentarios <span class="sort-indicator">↕</span></span></th>
              <th class="sortable-col" data-sort-type="percent"><span class="sort-label">% sobre texto <span class="sort-indicator">↕</span></span></th>
              <th class="sortable-col" data-sort-type="decimal"><span class="sort-label">IBB atributo <span class="sort-indicator">↕</span></span></th>
              <th class="sortable-col" data-sort-type="decimal"><span class="sort-label">Uplift atributo <span class="sort-indicator">↕</span></span></th>
            </tr>
          </thead>
          <tbody id="drivers-tbody"></tbody>
        </table>
      </div>

      <div class="ranking-row">
        <div class="ranking-card">
          <div class="ranking-title">Evolución IBB atributo</div>
          <div class="table-wrapper table-wrapper-ranking">
            <table class="ranking-table ranking-csat">
              <thead>
                <tr>
                  <th>Driver</th>
                  <th class="sortable-col" data-sort-type="decimal"><span class="sort-label">IBB Anual<span class="sort-indicator">↕</span></span></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="ranking-card">
          <div class="ranking-title">Evolución Uplift atributo</div>
          <div class="table-wrapper table-wrapper-ranking">
            <table class="ranking-table ranking-uplift">
              <thead>
                <tr>
                  <th>Driver</th>
                  <th class="sortable-col" data-sort-type="decimal"><span class="sort-label">Uplift Anual<span class="sort-indicator">↕</span></span></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <div class="section-title">SERVICIOS AGREGADOS</div>
    <section class="card">
      <div class="level-tag">Vista jerárquica: Servicio > Centro > Driver. Ordenar y filtrar afecta las métricas.</div>

      <div class="filter-row">
        <span class="filter-label">Filtrar Trimestres:</span>
        <div class="trim-pills" id="trim-filter">
          <div class="trim-pill selected" data-trim="1">T1</div>
          <div class="trim-pill selected" data-trim="2">T2</div>
          <div class="trim-pill selected" data-trim="3">T3</div>
          <div class="trim-pill selected" data-trim="4">T4</div>
        </div>
        <span class="filter-hint">Presiona para activar/desactivar.</span>
      </div>

      <div class="table-wrapper">
        <table id="services-table">
          <thead>
            <tr>
              <th>Servicio / Centro / Driver</th>
              <th style="width: 50px;"></th> 
              <th class="sortable-col" data-sort-type="int" data-col-index="2"><span class="sort-label">N° comentarios <span class="sort-indicator">↕</span></span></th>
              <th class="sortable-col" data-sort-type="percent" data-col-index="3"><span class="sort-label">% sobre texto <span class="sort-indicator">↕</span></span></th>
              <th class="sortable-col" data-sort-type="decimal" data-col-index="4"><span class="sort-label">IBB <span class="sort-indicator">↕</span></span></th>
              <th class="sortable-col" data-sort-type="decimal" data-col-index="5"><span class="sort-label">Uplift <span class="sort-indicator">↕</span></span></th>
            </tr>
          </thead>
          <tbody id="services-tbody"></tbody>
        </table>
      </div>
      <div class="note-inline">Usa los botones <b>+</b> para ver el desglose. Haz clic en los títulos para ordenar.</div>
    </section>
  </div>

  <script>
    // --- VARIABLES GLOBALES ---
    var REDSALUD_DATA = null;
    var selectedTrims = [1, 2, 3, 4]; // Por defecto todos

    // --- UTILIDADES ---
    function parseCellValue(text, type) {
      if (!text) return null;
      text = text.trim();
      if (text === '–' || text === '-' || text === 'Cargando...') return null;
      if (type === 'percent') text = text.replace('%', '');
      text = text.replace(/\./g, '').replace(',', '.'); 
      var val = parseFloat(text);
      return isNaN(val) ? null : val;
    }

    function formatDecimal(value, decimals, withSign) {
      if (value === null || typeof value === 'undefined' || isNaN(value)) return '–';
      var fixed = value.toFixed(decimals);
      var out = fixed.replace('.', ',');
      if (withSign && value > 0) out = '+' + out;
      return out;
    }

    function getIBBClass(v) {
      if (v === null || isNaN(v)) return 'neutral';
      if (v >= 10.0) return 'pos';
      if (v <= -10.0) return 'neg';
      return 'neutral';
    }

    function getUpliftClass(v) {
      if (v === null || isNaN(v)) return 'neutral';
      if (v > 0.001) return 'pos';
      if (v < -0.001) return 'neg';
      return 'neutral';
    }

    // --- AGREGACIÓN DINÁMICA POR TRIMESTRE (FILTRADO) ---
    function aggregateDataForTrims(dataCenters, trims) {
      var totalCommentsSelected = 0;
      var weightedIBBSumSelected = 0;
      var aggregatedServices = {};

      dataCenters.forEach(centerData => {
        var centerName = centerData.center;
        
        centerData.services.forEach(serviceData => {
          serviceData.attributes.forEach(attr => {
            // DETECTAR TRIMESTRE
            // Se asume formato "YYYY-TX". Si no existe, se considera data anual (sin trimestre).
            var quarter = 0;
            if (attr.trimestre) {
                var parts = attr.trimestre.split('-');
                if (parts.length > 1) quarter = parseInt(parts[1].replace('T', ''), 10);
            }
            
            // LÓGICA DE FILTRADO PERMISIVA
            // 1. Si la data tiene trimestre, filtrar según selección.
            // 2. Si la data NO tiene trimestre (es anual), incluirla siempre para que la tabla no quede vacía.
            var include = false;
            if (quarter > 0) {
                if (trims.includes(quarter)) include = true;
            } else {
                include = true; // Fallback para data sin trimestre explícito
            }

            if (!include) return;

            // ACUMULAR MÉTRICAS
            totalCommentsSelected += attr.count;
            weightedIBBSumSelected += (attr.count * attr.ibb);

            var sName = serviceData.service;
            
            // Inicializar estructuras si no existen
            if (!aggregatedServices[sName]) aggregatedServices[sName] = { total_count: 0, weighted_ibb_sum: 0, centers: {} };
            if (!aggregatedServices[sName].centers[centerName]) aggregatedServices[sName].centers[centerName] = { count: 0, weighted_ibb_sum: 0, drivers: {} };
            if (!aggregatedServices[sName].centers[centerName].drivers[attr.attribute]) aggregatedServices[sName].centers[centerName].drivers[attr.attribute] = { count: 0, weighted_ibb_sum: 0 };

            // Sumar a Servicio
            aggregatedServices[sName].total_count += attr.count;
            aggregatedServices[sName].weighted_ibb_sum += (attr.count * attr.ibb);
            
            // Sumar a Centro
            aggregatedServices[sName].centers[centerName].count += attr.count;
            aggregatedServices[sName].centers[centerName].weighted_ibb_sum += (attr.count * attr.ibb);

            // Sumar a Driver
            var drv = aggregatedServices[sName].centers[centerName].drivers[attr.attribute];
            drv.count += attr.count;
            drv.weighted_ibb_sum += (attr.count * attr.ibb);
          });
        });
      });

      var overallIBB = totalCommentsSelected > 0 ? weightedIBBSumSelected / totalCommentsSelected : 0;
      return { overallIBB, totalCommentsSelected, aggregatedServices };
    }

    // --- RENDERIZADO DE TABLA DE SERVICIOS ---
    function renderServicesTable(year, trims) {
      var tbody = document.getElementById('services-tbody');
      if (!tbody || !REDSALUD_DATA) return;

      var dataCenters = REDSALUD_DATA.services_breakdown.Centers || [];
      
      // 1. Calcular Datos Agregados según Filtros
      var result = aggregateDataForTrims(dataCenters, trims);
      var aggServices = result.aggregatedServices;
      var overallIBB = result.overallIBB;
      var totalGlobal = result.totalCommentsSelected || 1;

      // Actualizar KPIs de Cabecera
      document.getElementById('total-comments').textContent = new Intl.NumberFormat('es-CL').format(result.totalCommentsSelected);
      document.getElementById('overall-ibb').textContent = formatDecimal(overallIBB, 2, false);
      document.getElementById('overall-ibb').className = 'summary-value ' + getIBBClass(overallIBB);

      tbody.innerHTML = '';
      if (Object.keys(aggServices).length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No hay datos para los trimestres seleccionados.</td></tr>';
        return;
      }

      var serviceKeys = Object.keys(aggServices).sort();

      serviceKeys.forEach(function(sName) {
        var sData = aggServices[sName];
        var sKey = sName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
        
        // Métricas Servicio
        var sIBB = sData.total_count > 0 ? sData.weighted_ibb_sum / sData.total_count : 0;
        var sUplift = sIBB - overallIBB;
        var sPct = sData.total_count / totalGlobal * 100;

        // FILA SERVICIO (Nivel 1)
        var trS = document.createElement('tr');
        trS.className = 'service-row';
        trS.innerHTML = `
          <td class="tbl-name"><strong>${sName}</strong> <button class="plus-btn service-group-toggle" data-key="${sKey}" data-expanded="false">+</button></td>
          <td></td>
          <td class="tbl-num">${new Intl.NumberFormat('es-CL').format(sData.total_count)}</td>
          <td class="tbl-num">${formatDecimal(sPct, 1, false)}%</td>
          <td class="tbl-num val-csat ${getIBBClass(sIBB)}">${formatDecimal(sIBB, 2, false)}</td>
          <td class="tbl-num val-uplift ${getUpliftClass(sUplift)}">${formatDecimal(sUplift, 2, true)}</td>
        `;
        tbody.appendChild(trS);

        // FILAS CENTROS (Nivel 2)
        var centerKeys = Object.keys(sData.centers).sort();
        centerKeys.forEach(function(cName) {
          var cData = sData.centers[cName];
          var cKey = sKey + '-' + cName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
          
          var cIBB = cData.count > 0 ? cData.weighted_ibb_sum / cData.count : 0;
          var cUplift = cIBB - overallIBB;
          var cPct = cData.count / totalGlobal * 100;

          var trC = document.createElement('tr');
          trC.className = 'center-row';
          trC.style.display = 'none'; // Oculto inicial
          trC.setAttribute('data-parent-service', sKey);
          trC.innerHTML = `
            <td class="tbl-name">${cName} <button class="plus-btn driver-toggle" data-key="${cKey}" data-expanded="false">+</button></td>
            <td></td>
            <td class="tbl-num">${new Intl.NumberFormat('es-CL').format(cData.count)}</td>
            <td class="tbl-num">${formatDecimal(cPct, 1, false)}%</td>
            <td class="tbl-num val-csat ${getIBBClass(cIBB)}">${formatDecimal(cIBB, 2, false)}</td>
            <td class="tbl-num val-uplift ${getUpliftClass(cUplift)}">${formatDecimal(cUplift, 2, true)}</td>
          `;
          tbody.appendChild(trC);

          // FILAS DRIVERS (Nivel 3)
          var drvKeys = Object.keys(cData.drivers).sort((a,b) => cData.drivers[b].count - cData.drivers[a].count);
          drvKeys.forEach(function(dName) {
            var dData = cData.drivers[dName];
            var dIBB = dData.count > 0 ? dData.weighted_ibb_sum / dData.count : 0;
            var dUplift = dIBB - overallIBB;
            var dPct = dData.count / totalGlobal * 100;

            var trD = document.createElement('tr');
            trD.className = 'driver-row';
            trD.style.display = 'none'; // Oculto inicial
            trD.setAttribute('data-parent-center', cKey);
            trD.innerHTML = `
              <td class="tbl-name">${dName}</td>
              <td></td>
              <td class="tbl-num">${new Intl.NumberFormat('es-CL').format(dData.count)}</td>
              <td class="tbl-num">${formatDecimal(dPct, 1, false)}%</td>
              <td class="tbl-num val-csat ${getIBBClass(dIBB)}">${formatDecimal(dIBB, 2, false)}</td>
              <td class="tbl-num val-uplift ${getUpliftClass(dUplift)}">${formatDecimal(dUplift, 2, true)}</td>
            `;
            tbody.appendChild(trD);
          });
        });
      });

      initToggles();
    }

    // --- TOGGLES DE EXPANSIÓN ---
    function initToggles() {
      // Toggle Servicio -> Centros
      document.querySelectorAll('.service-group-toggle').forEach(btn => {
        btn.addEventListener('click', function() {
          var sKey = this.dataset.key;
          var expanded = this.dataset.expanded === 'true';
          this.textContent = expanded ? '+' : '–';
          this.dataset.expanded = !expanded;

          var centers = document.querySelectorAll(`.center-row[data-parent-service="${sKey}"]`);
          centers.forEach(row => {
            row.style.display = expanded ? 'none' : 'table-row';
            if (expanded) { // Si cerramos servicio, cerrar también drivers
               var cKey = row.querySelector('.driver-toggle').dataset.key;
               var drivers = document.querySelectorAll(`.driver-row[data-parent-center="${cKey}"]`);
               drivers.forEach(d => d.style.display = 'none');
               var cBtn = row.querySelector('.driver-toggle');
               cBtn.textContent = '+'; cBtn.dataset.expanded = 'false';
            }
          });
        });
      });

      // Toggle Centro -> Drivers
      document.querySelectorAll('.driver-toggle').forEach(btn => {
        btn.addEventListener('click', function() {
          var cKey = this.dataset.key;
          var expanded = this.dataset.expanded === 'true';
          this.textContent = expanded ? '+' : '–';
          this.dataset.expanded = !expanded;

          var drivers = document.querySelectorAll(`.driver-row[data-parent-center="${cKey}"]`);
          drivers.forEach(row => {
            row.style.display = expanded ? 'none' : 'table-row';
          });
        });
      });
    }

    // --- ORDENAMIENTO (SORTING) ---
    function initSorting() {
        document.querySelectorAll('#services-table thead .sortable-col').forEach(th => {
            th.addEventListener('click', function() {
                var table = document.getElementById('services-table');
                var tbody = table.querySelector('tbody');
                var colIndex = parseInt(this.dataset.colIndex);
                var type = this.dataset.sortType;
                var currentDir = this.dataset.dir || 'asc';
                var nextDir = currentDir === 'asc' ? 'desc' : 'asc';
                this.dataset.dir = nextDir;

                // Indicadores
                document.querySelectorAll('#services-table .sort-indicator').forEach(i => i.textContent = '↕');
                this.querySelector('.sort-indicator').textContent = nextDir === 'asc' ? '▲' : '▼';

                // 1. CAPTURAR ESTRUCTURA COMPLETA
                var groups = []; 
                var currentGroup = null;
                
                Array.from(tbody.children).forEach(row => {
                    if (row.classList.contains('service-row')) {
                        if (currentGroup) groups.push(currentGroup);
                        currentGroup = { row: row, children: [] };
                    } else {
                        if (currentGroup) currentGroup.children.push(row);
                    }
                });
                if (currentGroup) groups.push(currentGroup);

                // 2. ORDENAR LOS GRUPOS (Por valor de Servicio)
                groups.sort((a, b) => {
                    var valA = parseCellValue(a.row.children[colIndex].textContent, type);
                    var valB = parseCellValue(b.row.children[colIndex].textContent, type);
                    if (valA === null) return 1; 
                    if (valB === null) return -1;
                    return nextDir === 'asc' ? valA - valB : valB - valA;
                });

                // 3. RECONSTRUIR DOM
                tbody.innerHTML = '';
                groups.forEach(g => {
                    tbody.appendChild(g.row);
                    g.children.forEach(child => tbody.appendChild(child));
                });
                
                // Reinicializar toggles (necesario tras mover elementos)
                initToggles();
            });
        });
        
        // Sorting simple para Drivers Macro
        document.querySelectorAll('#drivers-table thead .sortable-col').forEach(th => {
             th.addEventListener('click', function() {
                var table = document.getElementById('drivers-table');
                var tbody = table.querySelector('tbody');
                var colIndex = Array.prototype.indexOf.call(th.parentNode.children, th);
                var type = this.dataset.sortType;
                var nextDir = this.dataset.dir === 'asc' ? 'desc' : 'asc';
                this.dataset.dir = nextDir;
                
                document.querySelectorAll('#drivers-table .sort-indicator').forEach(i => i.textContent = '↕');
                this.querySelector('.sort-indicator').textContent = nextDir === 'asc' ? '▲' : '▼';

                var rows = Array.from(tbody.querySelectorAll('tr'));
                rows.sort((a, b) => {
                    var valA = parseCellValue(a.children[colIndex].textContent, type);
                    var valB = parseCellValue(b.children[colIndex].textContent, type);
                    if (valA === null) return 1; if (valB === null) return -1;
                    return nextDir === 'asc' ? valA - valB : valB - valA;
                });
                tbody.innerHTML = '';
                rows.forEach(r => tbody.appendChild(r));
             }); 
        });
    }

    // --- CARGA DE DATOS ---
    async function fetchData() {
      const JSON_URL = './data_redsalud.json';
      try {
        const response = await fetch(JSON_URL);
        if (!response.ok) throw new Error("Error HTTP " + response.status);
        REDSALUD_DATA = await response.json();
        console.log("Data cargada OK");
        
        renderDriversMacro('2025');
        renderEvolutionTables('2025');
        renderServicesTable('2025', selectedTrims);
        initSorting();

      } catch (err) {
        console.error(err);
        document.getElementById('overall-ibb').textContent = "Error";
        alert("No se pudo cargar el archivo data_redsalud.json. Verifique la ruta.");
      }
    }

    // --- RENDER DRIVERS MACRO (Flat) ---
    function renderDriversMacro(year) {
        var tbody = document.getElementById('drivers-tbody');
        if(!REDSALUD_DATA) return;
        var data = REDSALUD_DATA.drivers_macro || [];
        var total = data.reduce((acc, r) => acc + r.count, 0);
        tbody.innerHTML = '';
        
        data.forEach(r => {
            var tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="tbl-name">${r.attribute}</td>
                <td class="tbl-num">${new Intl.NumberFormat('es-CL').format(r.count)}</td>
                <td class="tbl-num">${formatDecimal(r.count/total*100, 1, false)}%</td>
                <td class="tbl-num val-csat ${getIBBClass(r.ibb)}">${formatDecimal(r.ibb, 2, false)}</td>
                <td class="tbl-num val-uplift ${getUpliftClass(r.uplift)}">${formatDecimal(r.uplift, 2, true)}</td>
            `;
            tbody.appendChild(tr);
        });
    }
    
    function renderEvolutionTables(year) {
        var csatBody = document.querySelector('.ranking-csat tbody');
        var upliftBody = document.querySelector('.ranking-uplift tbody');
        var csatHead = document.querySelector('.ranking-csat thead tr');
        var upliftHead = document.querySelector('.ranking-uplift thead tr');
        
        if (!csatBody || !REDSALUD_DATA || !REDSALUD_DATA.evolution_ibb) return;

        var ibbRows = REDSALUD_DATA.evolution_ibb;
        var upliftRows = REDSALUD_DATA.evolution_uplift;
        var availableQuarters = ibbRows.map(r => r.trimestre.split('-')[1]).filter((v,i,a)=>a.indexOf(v)===i).sort();
        var allAttributes = REDSALUD_DATA.drivers_macro.map(d => d.attribute);

        // Limpiar headers dinámicos previos
        while(csatHead.children.length > 1) csatHead.removeChild(csatHead.lastChild);
        while(upliftHead.children.length > 1) upliftHead.removeChild(upliftHead.lastChild);

        // Crear headers
        availableQuarters.forEach(q => {
            var th1 = document.createElement('th'); th1.className='sortable-col'; th1.innerHTML=`<span class="sort-label">${q}</span>`; csatHead.appendChild(th1);
            var th2 = document.createElement('th'); th2.className='sortable-col'; th2.innerHTML=`<span class="sort-label">${q}</span>`; upliftHead.appendChild(th2);
        });
        // Headers totales
        var thT1 = document.createElement('th'); thT1.innerHTML=`<span class="sort-label">Total Anual</span>`; csatHead.appendChild(thT1);
        var thT2 = document.createElement('th'); thT2.innerHTML=`<span class="sort-label">Total Anual</span>`; upliftHead.appendChild(thT2);

        csatBody.innerHTML = ''; upliftBody.innerHTML = '';

        allAttributes.forEach(attr => {
            // IBB ROW
            var trI = document.createElement('tr');
            trI.innerHTML = `<td class="tbl-name">${attr}</td>`;
            availableQuarters.forEach(q => {
                var row = ibbRows.find(r => r.trimestre.endsWith(q));
                var val = row ? row[attr] : null;
                trI.innerHTML += `<td class="tbl-num val-csat ${getIBBClass(val)}">${formatDecimal(val, 2, false)}</td>`;
            });
            var annual = REDSALUD_DATA.drivers_macro.find(d => d.attribute === attr);
            trI.innerHTML += `<td class="tbl-num val-csat ${getIBBClass(annual.ibb)}"><b>${formatDecimal(annual.ibb, 2, false)}</b></td>`;
            csatBody.appendChild(trI);

            // UPLIFT ROW
            var trU = document.createElement('tr');
            trU.innerHTML = `<td class="tbl-name">${attr}</td>`;
            availableQuarters.forEach(q => {
                var row = upliftRows.find(r => r.trimestre.endsWith(q));
                var val = row ? row[attr] : null;
                trU.innerHTML += `<td class="tbl-num val-uplift ${getUpliftClass(val)}">${formatDecimal(val, 2, true)}</td>`;
            });
            trU.innerHTML += `<td class="tbl-num val-uplift ${getUpliftClass(annual.uplift)}"><b>${formatDecimal(annual.uplift, 2, true)}</b></td>`;
            upliftBody.appendChild(trU);
        });
    }

    // --- EVENTOS FILTRO TRIMESTRAL ---
    document.querySelectorAll('#trim-filter .trim-pill').forEach(pill => {
      pill.addEventListener('click', function() {
        var t = parseInt(this.dataset.trim);
        var idx = selectedTrims.indexOf(t);
        if (idx !== -1) {
          if (selectedTrims.length > 1) { selectedTrims.splice(idx, 1); this.classList.remove('selected'); }
        } else {
          selectedTrims.push(t); this.classList.add('selected');
        }
        renderServicesTable('2025', selectedTrims);
      });
    });

    document.addEventListener('DOMContentLoaded', fetchData);
  </script>
</body>
</html>
